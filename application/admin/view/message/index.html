<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>内容管理 - 后台管理系统</title>
    <link rel="stylesheet" href="/static/layui/css/layui.css">
    <link rel="stylesheet" href="/static/admin/css/style.css">
</head>

<body>
    <div class="layui-fluid">
        <div class="layui-card">
            <div class="layui-card-header">
                <h2>内容管理</h2>
            </div>
            <div class="layui-card-body">
                <!-- 搜索表单 -->
                <form class="layui-form" lay-filter="search-form">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">关键词搜索</label>
                            <div class="layui-input-inline">
                                <input type="text" name="keyword" placeholder="搜索内容或转发内容" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">用户搜索</label>
                            <div class="layui-input-inline">
                                <input type="text" name="username" placeholder="搜索用户名或昵称" class="layui-input">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">时间范围</label>
                            <div class="layui-input-inline">
                                <input type="text" name="start_time" placeholder="开始时间" class="layui-input"
                                    id="start-time">
                            </div>
                            <div class="layui-form-mid">-</div>
                            <div class="layui-input-inline">
                                <input type="text" name="end_time" placeholder="结束时间" class="layui-input" id="end-time">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <button class="layui-btn layui-btn-primary" type="button" id="reset-search">重置</button>
                            <button class="layui-btn" lay-submit lay-filter="search-submit">搜索</button>
                        </div>
                    </div>
                </form>

                <!-- 操作按钮 -->
                <div class="layui-btn-container" style="margin-bottom: 15px;">
                    <button class="layui-btn layui-btn-danger" id="batch-delete">
                        <i class="layui-icon layui-icon-delete"></i> 批量删除
                    </button>
                </div>

                <!-- 数据表格 -->
                <table id="message-table" lay-filter="message-table"></table>
            </div>
        </div>
    </div>

    <!-- 表格行操作模板 -->
    <script type="text/html" id="message-toolbar">
        <a class="layui-btn layui-btn-xs" lay-event="show">查看</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="delete">删除</a>
    </script>

    <script src="/static/layui/layui.js"></script>
    <script>
        layui.use(['layer', 'form', 'table', 'laydate'], function () {
            var layer = layui.layer;
            var form = layui.form;
            var table = layui.table;
            var laydate = layui.laydate;
            var $ = layui.$;

            // 初始化日期选择器
            laydate.render({
                elem: '#start-time',
                theme: '#448aff'
            });

            laydate.render({
                elem: '#end-time',
                theme: '#448aff'
            });

            // 初始化表格
            var messageTable = table.render({
                elem: '#message-table',
                url: '{:url("getList")}',
                method: 'POST',
                page: true,
                limit: 20,
                limits: [10, 20, 30, 50, 100],
                height: 'full',
                lineStyle: 'height: 151px;', // 定义表格的多行样式
                cols: [[
                    { type: 'checkbox' },
                    { field: 'msg_id', title: 'ID', width: 80, sort: true },
                    { field: 'blog', title: '用户ID', width: 120 },
                    {
                        field: 'contents', title: '内容', templet: function (d) {
                            return d.contents || '-';
                        }
                    },
                    // {field: 'repost', title: '转发内容', width: 150, templet: function(d) {
                    //     return d.repost || '-';
                    // }},
                    {
                        field: 'media', title: '媒体', width: 100, templet: function (d) {
                            return d.media ? '<a href="javascript:void(0)" class="layui-btn layui-btn-xs media-preview" lay-event="preview" data-media="' + d.media + '">预览</a>' : '';
                        }
                    },
                    {
                        field: 'repostsum', title: '转发数', width: 80, templet: function (d) {
                            return d.repostsum || 0;
                        }
                    },
                    {
                        field: 'commentsum', title: '评论数', width: 80, templet: function (d) {
                            return d.commentsum || 0;
                        }
                    },
                    {
                        field: 'collectsum', title: '收藏数', width: 80, templet: function (d) {
                            return d.collectsum || 0;
                        }
                    },
                    {
                        field: 'ctime', title: '发布时间', width: 160, sort: true, templet: function (d) {
                            return new Date(d.ctime * 1000).toLocaleString('zh-CN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit'
                            });
                        }
                    },
                    { fixed: 'right', title: '操作', width: 150, toolbar: '#message-toolbar' }
                ]],
                response: {
                    statusCode: 0
                },
                parseData: function (res) {
                    return {
                        "code": 0,
                        "msg": res.msg,
                        "count": res.count,
                        "data": res.data
                    };
                }
            });

            // 搜索表单提交
            form.on('submit(search-submit)', function (data) {
                // 重新加载表格数据
                messageTable.reload({
                    where: data.field,
                    page: {
                        curr: 1 // 重新从第1页开始
                    }
                });
                return false;
            });

            // 重置搜索
            $('#reset-search').on('click', function () {
                // 清空表单
                form.val('search-form', {
                    keyword: '',
                    username: '',
                    start_time: '',
                    end_time: ''
                });
                // 重新加载表格数据
                messageTable.reload({
                    where: {},
                    page: {
                        curr: 1 // 重新从第1页开始
                    }
                });
            });

            // 表格行操作事件
            table.on('tool(message-table)', function (obj) {
                var data = obj.data;
                if (obj.event === 'show') {
                    // 跳转到详情页
                    window.location.href = '{:url("show", ["msg_id" => ""])}?msg_id=' + data.msg_id;
                } else if (obj.event === 'delete') {
                    // 单个删除
                    layer.confirm('确定要删除这条内容吗？', {
                        icon: 3,
                        title: '删除确认'
                    }, function (index) {
                        layer.close(index);
                        var loading = layer.load(2);

                        $.ajax({
                            url: '{:url("delete")}',
                            type: 'POST',
                            data: { msg_id: data.msg_id },
                            dataType: 'json',
                            success: function (res) {
                                layer.close(loading);
                                if (res.code === 1) {
                                    layer.msg(res.msg, { icon: 1 });
                                    obj.del(); // 删除表格行
                                } else {
                                    layer.msg(res.msg, { icon: 2 });
                                }
                            },
                            error: function () {
                                layer.close(loading);
                                layer.msg('请求失败，请重试', { icon: 2 });
                            }
                        });
                    });
                } else if (obj.event === 'preview') {
                    // 预览媒体文件
                    previewFile(data.media);
                }
            });

            // 批量删除
            $('#batch-delete').on('click', function () {
                var checkStatus = table.checkStatus('message-table');
                var data = checkStatus.data;

                if (data.length === 0) {
                    layer.msg('请选择要删除的内容', { icon: 3 });
                    return;
                }

                var checkedIds = data.map(function (item) {
                    return item.msg_id;
                });

                layer.confirm('确定要删除选中的 ' + data.length + ' 条内容吗？', {
                    icon: 3,
                    title: '批量删除确认'
                }, function (index) {
                    layer.close(index);
                    var loading = layer.load(2);

                    $.ajax({
                        url: '{:url("batchDelete")}',
                        type: 'POST',
                        data: { msg_ids: checkedIds },
                        dataType: 'json',
                        // traditional: true,
                        success: function (res) {
                            layer.close(loading);
                            if (res.code === 1) {
                                layer.msg(res.msg, { icon: 1 });
                                messageTable.reload(); // 重新加载表格
                            } else {
                                layer.msg(res.msg, { icon: 2 });
                            }
                        },
                        error: function () {
                            layer.close(loading);
                            layer.msg('请求失败，请重试', { icon: 2 });
                        }
                    });
                });
            });
        });
        // 媒体文件预览函数
        function previewFile(mediaUrl) {
            // 简单判断文件类型
            var fileName = mediaUrl.substring(mediaUrl.lastIndexOf('/') + 1);
            var fileType = fileName.substring(fileName.lastIndexOf('.') + 1).toLowerCase();

            // 图片预览
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(fileType)) {
                layer.open({
                    type: 1,
                    title: '图片预览',
                    area: ['80%', '80%'],
                    content: '<img src="' + mediaUrl + '" style="width:100%;height:100%;object-fit:contain;">',
                    cancel: function () {
                        // 关闭时的回调
                    }
                });
            }
            // 视频预览
            else if (['mp4', 'avi', 'mov', 'wmv', 'flv', 'mkv'].includes(fileType)) {
                layer.open({
                    type: 1,
                    title: '视频预览',
                    area: ['80%', '80%'],
                    content: '<video src="' + mediaUrl + '" controls style="width:100%;height:100%;object-fit:contain;"></video>',
                    cancel: function () {
                        // 关闭时的回调
                    }
                });
            }
            // 音频预览
            else if (['mp3', 'wav', 'ogg', 'aac', 'flac'].includes(fileType)) {
                layer.open({
                    type: 1,
                    title: '音频预览',
                    area: ['400px', '100px'],
                    content: '<audio src="' + mediaUrl + '" controls style="width:100%;"></audio>',
                    cancel: function () {
                        // 关闭时的回调
                    }
                });
            }
            // 其他文件类型
            else {
                layer.confirm('该文件类型不支持在线预览，是否下载？', {
                    icon: 3,
                    title: '文件预览',
                    btn: ['下载', '取消']
                }, function (index) {
                    layer.close(index);
                    window.open(mediaUrl);
                });
            }
        }
    </script>
</body>

</html>