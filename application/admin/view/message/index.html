<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>内容管理 - 后台管理系统</title>
    <link rel="stylesheet" href="/static/layui/css/layui.css">
     <link rel="stylesheet" href="/static/admin/css/style.css">
</head>
<body>
    <div class="layui-fluid">
        <div class="layui-card">
            <div class="layui-card-header">
                <h2>内容管理</h2>
            </div>
            <div class="layui-card-body">
                <!-- 搜索表单 -->
                <form class="layui-form" lay-filter="search-form">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">关键词搜索</label>
                            <div class="layui-input-inline">
                                <input type="text" name="keyword" value="{$keyword}" placeholder="搜索内容或转发内容" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">用户搜索</label>
                            <div class="layui-input-inline">
                                <input type="text" name="username" value="{$username}" placeholder="搜索用户名或昵称" class="layui-input">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">时间范围</label>
                            <div class="layui-input-inline">
                                <input type="text" name="start_time" value="{$start_time}" placeholder="开始时间" class="layui-input" id="start-time">
                            </div>
                            <div class="layui-form-mid">-</div>
                            <div class="layui-input-inline">
                                <input type="text" name="end_time" value="{$end_time}" placeholder="结束时间" class="layui-input" id="end-time">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <button class="layui-btn layui-btn-primary" type="reset" id="reset-search">重置</button>
                            <button class="layui-btn" lay-submit lay-filter="search-submit">搜索</button>
                        </div>
                    </div>
                </form>
                
                <!-- 操作按钮 -->
                <div class="layui-btn-container" style="margin-bottom: 15px;">
                    <button class="layui-btn layui-btn-danger" id="batch-delete">
                        <i class="layui-icon layui-icon-delete"></i> 批量删除
                    </button>
                </div>
                
                <!-- 数据表格 -->
                <table class="layui-table" lay-skin="line">
                    <thead>
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" lay-skin="primary" lay-filter="select-all"></th>
                            <th style="width: 80px;">ID</th>
                            <th style="width: 120px;">用户名</th>
                            <th>内容</th>
                            <th style="width: 150px;">转发内容</th>
                            <th style="width: 100px;">媒体</th>
                            <th style="width: 80px;">转发数</th>
                            <th style="width: 80px;">评论数</th>
                            <th style="width: 80px;">收藏数</th>
                            <th style="width: 160px;">发布时间</th>
                            <th style="width: 150px;">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {empty name="list"}
                        <tr>
                            <td colspan="11" align="center">暂无数据</td>
                        </tr>
                        {else/}
                        {volist name="list" id="message"}
                        <tr>
                            <td><input type="checkbox" name="msg_id" value="{$message.msg_id}" lay-skin="primary"></td>
                            <td>{$message.msg_id}</td>
                            <td>{$message.user.username|default='-'}</td>
                            <td class="content-preview">{$message.contents|default='-'}</td>
                            <td class="content-preview">{$message.repost|default='-'}</td>
                            <td>
                                {notempty name="message.media"}
                                <a href="{$message.media}" target="_blank" class="layui-btn layui-btn-xs media-link">查看</a>
                                {/notempty}
                            </td>
                            <td>{$message.repostsum|default=0}</td>
                            <td>{$message.commentsum|default=0}</td>
                            <td>{$message.collectsum|default=0}</td>
                            <td>{$message.ctime|date='Y-m-d H:i:s'}</td>
                            <td class="action-buttons">
                                <a href="{:url('show', ['msg_id' => $message.msg_id])}" class="layui-btn layui-btn-xs">查看</a>
                                <button class="layui-btn layui-btn-danger layui-btn-xs delete-btn" data-id="{$message.msg_id}">
                                    删除
                                </button>
                            </td>
                        </tr>
                        {/volist}
                        {/empty}
                    </tbody>
                </table>
                
                <!-- 分页 -->
                <div id="pagination">
                    {$list|raw|default=''}
                </div>
            </div>
        </div>
    </div>
    
    <script src="/static/layui/layui.js"></script>
    <script>
    layui.use(['layer', 'form', 'util', 'laydate'], function() {
        var layer = layui.layer;
        var form = layui.form;
        var util = layui.util;
        var laydate = layui.laydate;
        var $ = layui.$;
        
        // 初始化日期选择器
        laydate.render({
            elem: '#start-time',
            theme: '#448aff'
        });
        
        laydate.render({
            elem: '#end-time',
            theme: '#448aff'
        });
        
        // 全选功能
        form.on('checkbox(select-all)', function(data) {
            var checked = data.elem.checked;
            $('input[name="msg_id"]').prop('checked', checked);
            form.render('checkbox');
        });
        
        // 搜索表单提交
        form.on('submit(search-submit)', function(data) {
            var params = new URLSearchParams();
            for (var key in data.field) {
                if (data.field[key]) {
                    params.append(key, data.field[key]);
                }
            }
            var queryString = params.toString();
            window.location.href = '{:url("index")}' + (queryString ? '?' + queryString : '');
            return false;
        });
        
        // 重置搜索
        $('#reset-search').on('click', function() {
            window.location.href = '{:url("index")}';
        });
        
        // 单个删除
        $(document).on('click', '.delete-btn', function() {
            var msgId = $(this).data('id');
            var tr = $(this).closest('tr');
            
            layer.confirm('确定要删除这条内容吗？', {
                icon: 3,
                title: '删除确认'
            }, function(index) {
                layer.close(index);
                var loading = layer.load(2);
                
                $.ajax({
                    url: '{:url("delete")}',
                    type: 'POST',
                    data: {msg_id: msgId},
                    dataType: 'json',
                    success: function(res) {
                        layer.close(loading);
                        if (res.code === 1) {
                            layer.msg(res.msg, {icon: 1});
                            tr.remove();
                            // 如果表格为空，添加"暂无数据"行
                            if ($('tbody tr').length === 0) {
                                $('tbody').append('<tr><td colspan="11" align="center">暂无数据</td></tr>');
                            }
                        } else {
                            layer.msg(res.msg, {icon: 2});
                        }
                    },
                    error: function() {
                        layer.close(loading);
                        layer.msg('请求失败，请重试', {icon: 2});
                    }
                });
            });
        });
        
        // 批量删除
        $('#batch-delete').on('click', function() {
            var checkedIds = [];
            $('input[name="msg_id"]:checked').each(function() {
                checkedIds.push($(this).val());
            });
            
            if (checkedIds.length === 0) {
                layer.msg('请选择要删除的内容', {icon: 3});
                return;
            }
            
            layer.confirm('确定要删除选中的 ' + checkedIds.length + ' 条内容吗？', {
                icon: 3,
                title: '批量删除确认'
            }, function(index) {
                layer.close(index);
                var loading = layer.load(2);
                
                $.ajax({
                    url: '{:url("batchDelete")}',
                    type: 'POST',
                    data: {msg_ids: checkedIds},
                    dataType: 'json',
                    traditional: true,
                    success: function(res) {
                        layer.close(loading);
                        if (res.code === 1) {
                            layer.msg(res.msg, {icon: 1});
                            // 移除选中的行
                            $('input[name="msg_id"]:checked').closest('tr').remove();
                            // 如果表格为空，添加"暂无数据"行
                            if ($('tbody tr').length === 0) {
                                $('tbody').append('<tr><td colspan="11" align="center">暂无数据</td></tr>');
                            }
                            // 取消全选
                            $('input[lay-filter="select-all"]').prop('checked', false);
                            form.render('checkbox');
                        } else {
                            layer.msg(res.msg, {icon: 2});
                        }
                    },
                    error: function() {
                        layer.close(loading);
                        layer.msg('请求失败，请重试', {icon: 2});
                    }
                });
            });
        });
        
        // 渲染表单
        form.render();
    });
    </script>
</body>
</html>