<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户管理</title>
    <link rel="stylesheet" href="/static/layui/css/layui.css">
     <link rel="stylesheet" href="/static/admin/css/style.css">
</head>
<body>
    <div class="layui-container" style="margin-top: 20px;">
        <div class="layui-row">
            <div class="layui-col-md12">
                <div class="layui-card">
                    <div class="layui-card-header">
                        <span class="layui-breadcrumb">
                            <a href="javascript:;" lay-href="admin/index/index">首页</a>
                            <a><cite>用户管理</cite></a>
                        </span>
                    </div>
                    <div class="layui-card-body">
                        <!-- 搜索栏 -->
                        <form class="layui-form layui-form-item" lay-filter="search-form" style="margin-bottom: 20px;">
                            <div class="layui-input-inline" style="width: 300px;">
                                <input type="text" name="keyword" id="keyword" placeholder="请输入昵称、用户名、博客名或手机号" 
                                       value="{$keyword}" class="layui-input">
                            </div>
                            <div class="layui-input-inline">
                                <button class="layui-btn layui-btn-primary" lay-submit lay-filter="search-btn">
                                    <i class="layui-icon layui-icon-search"></i> 搜索
                                </button>
                            </div>
                            <div class="layui-input-inline">
                                <a href="{:url('admin/user/create')}" class="layui-btn">
                                    <i class="layui-icon layui-icon-plus"></i> 添加用户
                                </a>
                            </div>
                        </form>
                        
                        <!-- 用户列表表格 -->
                        <table id="user-table" class="layui-table" lay-even lay-skin="row">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>头像</th>
                                    <th>昵称</th>
                                    <th>用户名</th>
                                    <th>博客名</th>
                                    <th>手机号</th>
                                    <th>邮箱</th>
                                    <th>状态</th>
                                    <th>注册时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {empty name="users"}
                                <tr>
                                    <td colspan="10" align="center">暂无数据</td>
                                </tr>
                                {else/}
                                {volist name="users" id="user"}
                                <tr>
                                    <td>{$user.uid}</td>
                                    <td>
                                        <img src="{$user.head_image ?: '/static/images/default_avatar.png'}" 
                                             alt="头像" style="width: 40px; height: 40px; border-radius: 50%;">
                                    </td>
                                    <td>{$user.nickname}</td>
                                    <td>{$user.username ?: '-'}</td>
                                    <td>{$user.blog ?: '-'}</td>
                                    <td>{$user.phone ?: '-'}</td>
                                    <td>{$user.email ?: '-'}</td>
                                    <td>
                                        <span class="layui-badge {$user.status ? 'layui-bg-red' : 'layui-bg-green'}">
                                            {$user.status ? '已禁止' : '正常'}
                                        </span>
                                    </td>
                                    <td>{$user.ctime|date='Y-m-d H:i:s'}</td>
                                    <td>
                                        <div class="layui-btn-group">
                                            <a href="{:url('admin/user/edit', ['uid' => $user.uid])}" 
                                               class="layui-btn layui-btn-xs">编辑</a>
                                            <a href="{:url('admin/user/changePassword', ['uid' => $user.uid])}" 
                                               class="layui-btn layui-btn-xs layui-btn-warm">修改密码</a>
                                            <button class="layui-btn layui-btn-xs {$user.status ? 'layui-btn-normal' : 'layui-btn-danger'}" 
                                                    lay-event="toggleStatus" data-uid="{$user.uid}">
                                                {$user.status ? '启用' : '禁止'}
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {/volist}
                                {/empty}
                            </tbody>
                        </table>
                        
                        <!-- 分页 -->
                        <div class="layui-box layui-laypage layui-laypage-default" id="page">
                            {$page|default=''}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/static/layui/layui.js"></script>
    <script>
        layui.use(['jquery', 'layer', 'form'], function() {
            var $ = layui.jquery;
            var layer = layui.layer;
            var form = layui.form;
            
            // 搜索功能
            form.on('submit(search-btn)', function(data) {
                var keyword = data.field.keyword;
                window.location.href = '{:url("admin/user/index")}?keyword=' + encodeURIComponent(keyword);
                return false;
            });
            
            // 回车键搜索
            $('#keyword').keypress(function(e) {
                if (e.keyCode === 13) {
                    $('button[lay-filter="search-btn"]').trigger('click');
                    return false;
                }
            });
            
            // 切换用户状态
            $(document).on('click', 'button[lay-event="toggleStatus"]', function() {
                var uid = $(this).data('uid');
                var button = $(this);
                
                layer.confirm('确定要执行此操作吗？', {
                    btn: ['确定', '取消']
                }, function(index) {
                    layer.close(index);
                    
                    var loadIndex = layer.load(1);
                    
                    $.ajax({
                        url: '{:url("admin/user/toggleStatus")}',
                        type: 'post',
                        data: {uid: uid},
                        dataType: 'json',
                        success: function(res) {
                            layer.close(loadIndex);
                            if (res.code === 1) {
                                layer.msg(res.msg, {icon: 1}, function() {
                                    // 直接刷新页面而不是尝试重新加载表格
                                    location.reload();
                                });
                            } else {
                                layer.msg(res.msg, {icon: 2});
                            }
                        },
                        error: function() {
                            layer.close(loadIndex);
                            layer.msg('网络错误，请重试', {icon: 2});
                        }
                    });
                });
            });
        });
    </script>
</body>
</html>