<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户管理</title>
    <link rel="stylesheet" href="/static/layui/css/layui.css">
     <link rel="stylesheet" href="/static/admin/css/style.css">
</head>
<body>
    <div class="layui-fluid">
        <div class="layui-card">
            <div class="layui-card-header">
                <h2>用户管理</h2>
            </div>
            <div class="layui-card-body">
                <!-- 搜索表单 -->
                <form class="layui-form layui-form-item" lay-filter="search-form" style="margin-bottom: 20px;">
                    <div class="layui-input-inline" style="width: 300px;">
                        <input type="text" name="keyword" placeholder="请输入昵称、用户名、博客名或手机号" class="layui-input">
                    </div>
                    <div class="layui-input-inline">
                        <button class="layui-btn layui-btn-primary" lay-submit lay-filter="search-btn">
                            <i class="layui-icon layui-icon-search"></i> 搜索
                        </button>
                    </div>
                    <div class="layui-input-inline">
                        <a href="{:url('admin/user/create')}" class="layui-btn">
                            <i class="layui-icon layui-icon-plus"></i> 添加用户
                        </a>
                    </div>
                </form>
                
                <!-- 数据表格 -->
                <table id="user-table" lay-filter="user-table"></table>
            </div>
        </div>
    </div>
    <!-- 表格行操作模板 -->
    <script type="text/html" id="user-toolbar">
        <div class="layui-btn-group">
            <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
            <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="changePassword">修改密码</a>
            <a class="layui-btn layui-btn-xs {{d.status ? 'layui-btn-normal' : 'layui-btn-danger'}}" lay-event="toggleStatus">
                {{d.status ? '启用' : '禁止'}}
            </a>
        </div>
    </script>
    
    <!-- 状态模板 -->
    <script type="text/html" id="status-tpl">
        <span class="layui-badge {{d.status ? 'layui-bg-red' : 'layui-bg-green'}}">
            {{d.status ? '已禁止' : '正常'}}
        </span>
    </script>
    
    <!-- 头像模板 -->
    <script type="text/html" id="avatar-tpl">
        <img src="{{d.head_image || '/static/images/default_avatar.png'}}" 
             alt="头像" style="width: 40px; height: 40px; border-radius: 50%;">
    </script>
    
    <script src="/static/layui/layui.js"></script>
    <script>
        layui.use(['jquery', 'layer', 'form', 'table'], function() {
            var $ = layui.jquery;
            var layer = layui.layer;
            var form = layui.form;
            var table = layui.table;
            
            // 初始化表格
            var userTable = table.render({
                elem: '#user-table',
                url: '{:url("admin/user/getList")}',
                method: 'POST',
                page: true,
                limit: 20,
                limits: [10, 20, 30, 50, 100],
                height: 'full-35',
                 lineStyle: 'height: 50px;', // 定义表格的多行样式
                cols: [[
                    {field: 'uid', title: 'ID', width: 80, sort: true},
                    {field: 'head_image', title: '头像', width: 80, templet: '#avatar-tpl'},
                    {field: 'nickname', title: '昵称'},
                    // {field: 'username', title: '用户名', templet: function(d) { return d.username || '-'; }},
                    {field: 'blog', title: '博客名', width: 150, templet: function(d) { return d.blog || '-'; }},
                    {field: 'phone', title: '手机号', width: 120, templet: function(d) { return d.phone || '-'; }},
                    {field: 'email', title: '邮箱', templet: function(d) { return d.email || '-'; }},
                    {field: 'status', title: '状态', width: 100, templet: '#status-tpl'},
                    {field: 'ctime', title: '注册时间', width: 180, templet: function(d) { return d.ctime || '-'; }},
                    {field: 'uptime', title: '更新时间', width: 160, sort: true, templet: function(d) {
                        return new Date(d.uptime * 1000).toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                    }},
                    {fixed: 'right', title: '操作', width: 180, toolbar: '#user-toolbar'}
                ]],
                response: {
                    statusCode: 0
                },
                parseData: function(res) {
                    return {
                        "code": 0,
                        "msg": res.msg,
                        "count": res.count,
                        "data": res.data
                    };
                }
            });
            
            // 搜索功能
            form.on('submit(search-btn)', function(data) {
                // 重新加载表格数据
                userTable.reload({
                    where: data.field,
                    page: {
                        curr: 1 // 重新从第1页开始
                    }
                });
                return false;
            });
            
            // 回车键搜索
            $('#keyword').keypress(function(e) {
                if (e.keyCode === 13) {
                    $('button[lay-filter="search-btn"]').trigger('click');
                    return false;
                }
            });
            
            // 表格行操作事件
            table.on('tool(user-table)', function(obj) {
                var data = obj.data;
                
                if (obj.event === 'edit') {
                    // 跳转到编辑页面
                    window.location.href = '{:url("admin/user/edit", ["uid" => ""])}?uid=' + data.uid;
                } else if (obj.event === 'changePassword') {
                    // 跳转到修改密码页面
                    window.location.href = '{:url("admin/user/changePassword", ["uid" => ""])}?uid=' + data.uid;
                } else if (obj.event === 'toggleStatus') {
                    // 切换用户状态
                    layer.confirm('确定要执行此操作吗？', {
                        btn: ['确定', '取消']
                    }, function(index) {
                        layer.close(index);
                        
                        var loadIndex = layer.load(1);
                        
                        $.ajax({
                            url: '{:url("admin/user/toggleStatus")}',
                            type: 'post',
                            data: {uid: data.uid},
                            dataType: 'json',
                            success: function(res) {
                                layer.close(loadIndex);
                                if (res.code === 1) {
                                    layer.msg(res.msg, {icon: 1}, function() {
                                        // 重新加载表格
                                        userTable.reload();
                                    });
                                } else {
                                    layer.msg(res.msg, {icon: 2});
                                }
                            },
                            error: function() {
                                layer.close(loadIndex);
                                layer.msg('网络错误，请重试', {icon: 2});
                            }
                        });
                    });
                }
            });
        });
    </script>
</body>
</html>