<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>编辑友情链接</title>
    <link href="/static/layui/css/layui.css" rel="stylesheet">
</head>

<body>
    <div class="layui-layout">
        <div style="padding: 16px;">
            <div class="layui-card">
                <div class="layui-card-header" style="height: unset;">
                    <h3>编辑友情链接</h3>
                </div>
                <div class="layui-card-body">
                    <form class="layui-form" id="linkForm">
                        <input type="hidden" name="link_id" value="{$data.link_id}">
                        <div class="layui-form-item">
                            <label class="layui-form-label">分类</label>
                            <div class="layui-input-block">
                                <select name="link_category_id" required lay-verify="required" class="layui-select">
                                    <option value="">请选择分类</option>
                                    {volist name="categories" id="category"}
                                    <option value="{$category.link_category_id}" {if $data.link_category_id == $category.link_category_id}selected{/if}>{$category.category_name}</option>
                                    {/volist}
                                </select>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">网站名称</label>
                            <div class="layui-input-block">
                                <input type="text" name="site_name" required lay-verify="required" value="{$data.site_name}" placeholder="请输入网站名称" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">网站地址</label>
                            <div class="layui-input-block">
                                <input type="url" name="site_url" required lay-verify="required|url" value="{$data.site_url}" placeholder="请输入网站地址" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">网站LOGO</label>
                            <div class="layui-input-block">
                                <div class="layui-tab layui-tab-brief" lay-filter="logo-tab">
                                    <ul class="layui-tab-title">
                                        <li class="layui-this" data-type="upload">上传图片</li>
                                        <li data-type="url">填写地址</li>
                                    </ul>
                                    <div class="layui-tab-content">
                                        <div class="layui-tab-item layui-show">
                                            <div class="layui-upload">
                                                <button type="button" class="layui-btn" id="upload-logo">
                                                    <i class="layui-icon layui-icon-upload"></i> 选择图片
                                                </button>
                                                <div class="layui-upload-list" style="margin-top: 10px;">
                                                    <img class="layui-upload-img" id="preview-logo" style="max-width: 120px; max-height: 120px; display: none; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                                    <div id="logo-text"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layui-tab-item">
                                            <input type="text" 
                                                   name="logo_url" 
                                                   id="logo-url-input"
                                                   placeholder="请输入LOGO图片地址（http:// 或 https://）" 
                                                   autocomplete="off"
                                                   class="layui-input" value="{if strpos($data.site_logo, 'http') !== false}{$data.site_logo}{/if}">
                                            <div class="layui-upload-list" style="margin-top: 10px;">
                                                <img class="layui-upload-img" id="url-preview-logo" style="max-width: 120px; max-height: 120px; display: none; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);" {if strpos($data.site_logo, 'http') !== false}src="{$data.site_logo}"{/if}>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" 
                                       name="site_logo" 
                                       id="site-logo-input" value="{$data.site_logo}">
                                <div class="layui-form-mid layui-word-aux">请上传LOGO或填写图片地址</div>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">网站描述</label>
                            <div class="layui-input-block">
                                <textarea name="description" placeholder="请输入网站描述" class="layui-textarea">{$data.description}</textarea>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">排序</label>
                            <div class="layui-input-block">
                                <input type="number" name="sort_order" value="{$data.sort_order}" placeholder="请输入排序值" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <div class="layui-input-block">
                                <button class="layui-btn" lay-submit lay-filter="saveLink">保存</button>
                                <a class="layui-btn layui-btn-primary" href="/admin/cms/linkIndex">返回</a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/layui/layui.js"></script>
    <script>
        layui.use(['form', 'layer', 'upload', 'element'], function () {
            var form = layui.form;
            var layer = layui.layer;
            var upload = layui.upload;
            var element = layui.element;
            var $ = layui.$;
            
            // 初始化数据
            var initialLogoValue = $('#site-logo-input').val();
            
            // 检测初始值是否为URL还是已上传的文件，根据值决定默认显示哪个选项卡
            if(initialLogoValue && (initialLogoValue.startsWith('http://') || initialLogoValue.startsWith('https://'))) {
                // 如果初始值是URL，则切换到URL选项卡
                $('.layui-tab-title li[data-type="url"]').trigger('click');
                $('#logo-url-input').val(initialLogoValue);
                $('#url-preview-logo').attr('src', initialLogoValue).show();
            } else if(initialLogoValue) {
                // 如果是文件路径，则保持在上传选项卡并显示预览
                $('#preview-logo').attr('src', initialLogoValue).show();
            }

            // 图片上传
            var uploadInst = upload.render({
                elem: '#upload-logo',
                url: '{:url("admin/upload/upload")}',
                method: 'POST',
                data: {
                    type: 'logo'
                },
                accept: 'images',
                acceptMime: 'image/*',
                size: 2048, // 限制文件大小，单位 KB
                before: function(obj) {
                    // 预读本地文件示例，不支持ie8
                    obj.preview(function(index, file, result) {
                        $('#preview-logo').attr('src', result).show();
                    });
                    
                    layer.load(2);
                },
                done: function(res) {
                    layer.closeAll('loading');
                    
                    // 如果上传成功
                    if (res.code === 1) {
                        $('#site-logo-input').val(res.data.src);
                        $('#logo-text').html('<span style="color: #5FB878;"><i class="layui-icon layui-icon-ok-circle"></i> 上传成功</span>');
                        layer.msg('上传成功', {icon: 1});
                    } else {
                        // 显示错误信息
                        $('#logo-text').html('<span style="color: #FF5722;"><i class="layui-icon layui-icon-close"></i> 上传失败：' + res.msg + '</span>');
                        $('#preview-logo').hide();
                        layer.msg('上传失败：' + res.msg, {icon: 2});
                    }
                },
                error: function() {
                    layer.closeAll('loading');
                    
                    // 演示失败状态，并实现重传
                    $('#logo-text').html(`
                        <span style="color: #FF5722;">
                            <i class="layui-icon layui-icon-close"></i> 上传失败
                        </span>
                        <button class="layui-btn layui-btn-xs layui-btn-primary demo-reload" style="margin-left: 10px;">
                            <i class="layui-icon layui-icon-refresh"></i> 重试
                        </button>
                    `);
                    
                    $('#preview-logo').hide();
                    
                    $('#logo-text .demo-reload').on('click', function() {
                        uploadInst.upload();
                    });
                    
                    layer.msg('上传失败，请重试', {icon: 2});
                }
            });
            
            // 监听图片输入方式切换
            element.on('tab(logo-tab)', function(data){
                if(this.getAttribute('data-type') === 'url') {
                    // 切换到URL输入模式时清空隐藏字段
                    $('#site-logo-input').val('');
                    $('#url-preview-logo').hide();
                } else {
                    // 切换到上传模式时清空URL输入框
                    $('#logo-url-input').val('');
                    $('#url-preview-logo').hide();
                }
            });
            
            // 监听图片URL输入框变化
            $('#logo-url-input').on('input', function() {
                var logoUrl = $(this).val().trim();
                if(logoUrl) {
                    // 显示预览
                    showLogoPreview(logoUrl);
                    $('#site-logo-input').val(logoUrl); // 将URL设置为隐藏字段的值
                } else {
                    $('#url-preview-logo').hide();
                    $('#site-logo-input').val('');
                }
            });
            
            // 显示LOGO预览
            function showLogoPreview(url) {
                const img = new Image();
                img.onload = function() {
                    $('#url-preview-logo').attr('src', url).show();
                };
                img.onerror = function() {
                    $('#url-preview-logo').hide();
                    layer.msg('图片地址无效或无法访问', {icon: 2});
                };
                img.src = url;
            }

            // 监听提交
            form.on('submit(saveLink)', function (data) {
                var activeTab = $('.layui-tab-title .layui-this').data('type');
                var isValid = false;
                
                if(activeTab === 'upload') {
                    // 上传模式：检查隐藏字段是否有值
                    if($('#site-logo-input').val()) {
                        isValid = true;
                    } else {
                        layer.msg('请先上传LOGO', {icon: 2});
                        return false;
                    }
                } else if(activeTab === 'url') {
                    // URL模式：检查URL是否有效
                    var logoUrl = $('#logo-url-input').val().trim();
                    if(logoUrl) {
                        isValid = true;
                    } else {
                        layer.msg('请输入有效的LOGO图片地址', {icon: 2});
                        return false;
                    }
                }
                
                if(!isValid) {
                    layer.msg('请选择或输入有效的LOGO', {icon: 2});
                    return false;
                }
                
                $.ajax({
                    url: '/admin/cms/linkAddOrEdit',
                    type: 'post',
                    data: data.field,
                    dataType: 'json',
                    success: function (res) {
                        if (res.code === 0) {
                            layer.msg(res.msg, { icon: 6 });
                            setTimeout(function () {
                                window.location.href = '/admin/cms/linkIndex';
                            }, 1500);
                        } else {
                            layer.msg(res.msg, { icon: 5 });
                        }
                    },
                    error: function () {
                        layer.msg('请求失败', { icon: 5 });
                    }
                });
                return false;
            });
        });
    </script>
</body>

</html>