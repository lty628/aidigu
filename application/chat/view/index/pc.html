<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="/static/layui/css/layui.css?t=1" type="text/css" media="screen" />
	<style>
		/* 全局重置和基础设置 */
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		:root {
			--primary-color: #4f46e5;
			--secondary-color: #8b5cf6;
			--background-color: #f8fafc;
			--surface-color: #ffffff;
			--border-color: #e2e8f0;
			--text-primary: #1e293b;
			--text-secondary: #64748b;
			--success-color: #10b981;
			--warning-color: #f59e0b;
			--error-color: #ef4444;
			--shadow-light: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
			--shadow-medium: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
			--shadow-heavy: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
			--radius-small: 4px;
			--radius-medium: 8px;
			--radius-large: 12px;
			--transition-fast: 0.2s ease;
			--transition-medium: 0.3s ease;
			--transition-slow: 0.5s ease;
		}

		@media (prefers-color-scheme: dark) {
			:root {
				--background-color: #0f172a;
				--surface-color: #1e293b;
				--border-color: #334155;
				--text-primary: #f1f5f9;
				--text-secondary: #94a3b8;
			}
		}

		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
			background-color: var(--background-color);
			color: var(--text-primary);
			line-height: 1.6;
			height: 100vh;
			overflow: hidden;
		}

		/* 主容器布局 - 使用Flexbox实现响应式布局 */
		.chat-container {
			display: flex;
			height: 100vh;
			max-width: 1600px;
			margin: 0 auto;
			background-color: var(--surface-color);
			box-shadow: var(--shadow-medium);
			position: relative;
		}

		/* 菜单面板 - 固定宽度，使用flex-shrink防止压缩 */
		.menu-panel {
			width: 320px;
			background-color: var(--surface-color);
			border-right: 1px solid var(--border-color);
			display: flex;
			flex-direction: column;
			z-index: 10;
			transition: transform var(--transition-medium);
		}

		/* 移动端隐藏菜单 */
		@media (max-width: 768px) {
			.menu-panel {
				position: absolute;
				left: 0;
				top: 0;
				height: 100%;
				transform: translateX(-100%);
			}

			.menu-panel.active {
				transform: translateX(0);
			}
		}

		/* 头部样式 */
		.header {
			padding: 16px;
			border-bottom: 1px solid var(--border-color);
			display: flex;
			align-items: center;
			justify-content: space-between;
			background-color: var(--surface-color);
			position: relative;
			z-index: 20;
		}

		.header-title {
			font-size: 18px;
			font-weight: 600;
			color: var(--text-primary);
		}

		.mobile-back-btn {
			display: none;
			background: none;
			border: none;
			font-size: 20px;
			cursor: pointer;
			color: var(--text-primary);
			padding: 8px;
			border-radius: var(--radius-small);
		}

		.mobile-back-btn:hover {
			background-color: var(--border-color);
		}

		@media (max-width: 768px) {
			.mobile-back-btn {
				display: block;
			}
		}

		/* 对话列表 */
		.conversation-list {
			flex: 1;
			overflow-y: auto;
			padding: 16px;
		}

		.conversation-item {
			padding: 12px 16px;
			border-radius: var(--radius-medium);
			margin-bottom: 8px;
			cursor: pointer;
			transition: var(--transition-fast);
			border: 1px solid transparent;
			display: flex;
			align-items: center;
			gap: 12px;
		}

		.conversation-item img {
			width: 36px;
		}

		.conversation-item:hover {
			background-color: var(--border-color);
		}

		.conversation-item.active {
			background-color: var(--primary-color);
			color: white;
			border-color: var(--primary-color);
		}

		.conversation-item.active .conversation-title,
		.conversation-item.active .conversation-preview {
			color: white;
		}

		.conversation-avatar {
			width: 36px;
			height: 36px;
			border-radius: 50%;
			background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
			display: flex;
			align-items: center;
			justify-content: center;
			color: white;
			font-weight: bold;
			font-size: 14px;
		}

		.conversation-info {
			flex: 1;
			min-width: 0;
		}

		.conversation-title {
			font-weight: 500;
			color: var(--text-primary);
			margin-bottom: 4px;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		.conversation-preview {
			font-size: 13px;
			color: var(--text-secondary);
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		/* 内容面板 - 占据剩余空间 */
		.content-panel {
			flex: 1;
			display: flex;
			flex-direction: column;
			position: relative;
		}

		/* 消息内容区域 */
		.messages-container {
			flex: 1;
			overflow-y: auto;
			padding: 24px;
			display: flex;
			flex-direction: column;
			gap: 20px;
		}

		.message {
			max-width: 80%;
			padding: 16px;
			border-radius: var(--radius-large);
			animation: slideIn 0.3s ease-out;
			position: relative;
			word-wrap: break-word;
			word-break: break-word;
		}

		@keyframes slideIn {
			from {
				opacity: 0;
				transform: translateY(20px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.user-message {
			align-self: flex-end;
			background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
			color: white;
			border-bottom-right-radius: var(--radius-small);
		}

		.ai-message {
			align-self: flex-start;
			background-color: var(--border-color);
			color: var(--text-primary);
			border-bottom-left-radius: var(--radius-small);
		}

		/* 输入区域 */
		.input-area {
			padding: 20px;
			border-top: 1px solid var(--border-color);
			background-color: var(--surface-color);
		}

		.input-container {
			display: flex;
			gap: 12px;
			align-items: flex-end;
		}

		.message-input {
			flex: 1;
			padding: 14px 16px;
			border: 2px solid var(--border-color);
			border-radius: var(--radius-large);
			resize: none;
			min-height: 56px;
			max-height: 150px;
			font-size: 16px;
			outline: none;
			transition: var(--transition-fast);
			background-color: var(--surface-color);
			color: var(--text-primary);
		}

		.message-input:focus {
			border-color: var(--primary-color);
			box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
		}

		.send-button {
			padding: 14px 24px;
			background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
			color: white;
			border: none;
			border-radius: var(--radius-large);
			cursor: pointer;
			font-weight: 500;
			transition: var(--transition-fast);
			min-width: 80px;
		}

		.send-button:hover {
			transform: translateY(-1px);
			box-shadow: var(--shadow-medium);
		}

		.send-button:disabled {
			opacity: 0.6;
			cursor: not-allowed;
			transform: none;
			box-shadow: none;
		}

		/* 工具栏 */
		.toolbar {
			display: flex;
			gap: 12px;
			margin-top: 12px;
			flex-wrap: wrap;
		}

		.toolbar-button {
			padding: 8px 12px;
			border: 1px solid var(--border-color);
			background-color: var(--surface-color);
			border-radius: var(--radius-medium);
			cursor: pointer;
			transition: var(--transition-fast);
			font-size: 14px;
		}

		.toolbar-button:hover {
			background-color: var(--border-color);
			border-color: var(--primary-color);
		}

		/* 用户引导 */
		.user-guide {
			text-align: center;
			padding: 40px 20px;
			color: var(--text-secondary);
		}

		.guide-title {
			font-size: 24px;
			font-weight: 600;
			margin-bottom: 16px;
			color: var(--text-primary);
		}

		.guide-description {
			font-size: 16px;
			margin-bottom: 32px;
			max-width: 600px;
			margin-left: auto;
			margin-right: auto;
		}

		/* 响应式设计 */
		@media (max-width: 1000px) {
			.chat-container {
				flex-direction: column;
			}

			.menu-panel {
				width: 100%;
				height: auto;
				border-right: none;
				border-bottom: 1px solid var(--border-color);
				position: static;
				transform: none;
			}

			.menu-panel.active {
				position: absolute;
				height: 100%;
			}

			.content-panel {
				min-height: 500px;
			}

			.message {
				max-width: 90%;
			}
		}

		@media (max-width: 768px) {
			.chat-container {
				height: 100vh;
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
			}

			.messages-container {
				padding: 16px;
			}

			.input-area {
				padding: 16px;
			}

			.message {
				max-width: 95%;
			}

			.conversation-list {
				padding: 12px;
			}

			.conversation-item {
				padding: 12px;
			}
		}

		/* 滚动条美化 */
		::-webkit-scrollbar {
			width: 6px;
			height: 6px;
		}

		::-webkit-scrollbar-track {
			background: transparent;
		}

		::-webkit-scrollbar-thumb {
			background: var(--border-color);
			border-radius: 3px;
		}

		::-webkit-scrollbar-thumb:hover {
			background: var(--text-secondary);
		}

		/* 高对比度模式支持 */
		@media (prefers-contrast: high) {
			:root {
				--border-color: #000000;
				--text-primary: #000000;
			}
		}

		/* 减少动画模式支持 */
		@media (prefers-reduced-motion: reduce) {
			* {
				animation-duration: 0.01ms !important;
				animation-iteration-count: 1 !important;
				transition-duration: 0.01ms !important;
			}
		}

		/* 加载状态 */
		.loading {
			display: inline-block;
			width: 20px;
			height: 20px;
			border: 3px solid var(--border-color);
			border-radius: 50%;
			border-top-color: var(--primary-color);
			animation: spin 1s ease-in-out infinite;
		}

		@keyframes spin {
			to {
				transform: rotate(360deg);
			}
		}
	</style>
</head>

<body>
	<div class="chat-container">
		<!-- 菜单面板 -->
		<div class="menu-panel" id="menuPanel">
			<div class="header">
				<button class="mobile-back-btn" id="mobileBackBtn" style="display:none;">←</button>
				<h2 class="header-title">对话历史</h2>
				<div style="width: 24px;"></div> <!-- 占位符保持居中 -->
			</div>
			<div class="conversation-list" id="conversationList">
				<!-- 对话项目将通过JavaScript动态生成 -->
				<div class="conversation-item active">
					<div class="conversation-avatar">A</div>
					<div class="conversation-info">
						<div class="conversation-title">新对话</div>
						<div class="conversation-preview">开始新的对话...</div>
					</div>
				</div>
			</div>
		</div>

		<!-- 内容面板 -->
		<div class="content-panel">
			<div class="messages-container" id="messagesContainer">
				<!-- 消息将通过JavaScript动态生成 -->
				<div class="user-guide" id="userGuide">
					<h3 class="guide-title">欢迎使用AI对话助手</h3>
					<p class="guide-description">在这里您可以与AI进行智能对话，提出问题或讨论话题，AI将为您提供帮助和解答。</p>
				</div>
			</div>

			<div class="input-area">
				<div class="toolbar" id="msgToolBar">
					<button class="toolbar-button" data-action="clear">清空对话</button>
					<button class="toolbar-button" data-action="export">导出对话</button>
					<button class="toolbar-button" data-action="help">帮助</button>
				</div>
				<div class="input-container">
					<div class="message-input" id="msgInput"></div>
					<button class="send-button" id="sendButton" disabled>发送</button>
				</div>
			</div>
		</div>
	</div>
	<input type="hidden" id="from_uid" value="{$fromuid}">
	<script src="/static/layui/layui.js?4"></script>
	<script>var $ = layui.jquery;</script>
	<script language="javascript" type="text/javascript" src="/static/common/js/index.js?22"></script>
	<script type="text/javascript" src="/static/common/js/wangEditor.min.js"></script>
	<script src="/static/chat/js/edit.js?v=12"></script>

	<script>
		// 配置信息
		const config = {
			'wsserver': "{$wsserver}",
			'reconnectInterval': 3000,
			'heartbeatInterval': 30000
		};

		// 主聊天对象
		var chat = {
			// 数据存储
			data: {
				wSock: null,
				uid: 0,
				fd: 0,
				crd: '',
				rds: [],
				touid: 0,
				listtagid: 'PrivateLetter',
				lockReconnect: false,
				heartbeatTimer: null,
				reconnectTimer: null
			},

			// 初始化WebSocket连接
			initConnection: function () {
				try {
					this.data.wSock = new WebSocket(config.wsserver);
					this.bindEvents();
				} catch (e) {
					console.error('WebSocket连接失败:', e);
					this.scheduleReconnect();
				}
			},

			// 绑定WebSocket事件
			bindEvents: function () {
				this.data.wSock.onopen = this.onOpen.bind(this);
				this.data.wSock.onmessage = this.onMessage.bind(this);
				this.data.wSock.onclose = this.onClose.bind(this);
				this.data.wSock.onerror = this.onError.bind(this);
			},

			// 连接打开处理
			onOpen: function (event) {
				this.startHeartbeat();
				chat.data.uid = $("#from_uid").val();
				var json = { "type": 0, "listtagid": 'TagInfo', "uid": chat.data.uid };
				chat.sendMessage(json);
			},

			// 接收消息处理
			onMessage: function (event) {
				this.resetHeartbeat();

				try {
					const data = JSON.parse(event.data);
					// {"code":4,"msg":"success","data":{"mine":0,"listtags":[{"listtagid":"PrivateLetter","listtagname":"私信","display":"block"}
					// ,{"listtagid":"Friends","listtagname":"好友","display":"block"}
					// ,{"listtagid":"Group","listtagname":"群聊","display":"block"}
					// ,{"listtagid":"MessageChat","listtagname":"评论","display":"none"}
					// ,{"listtagid":"ChannelMessageChat","listtagname":"频道评论","display":"none"}],
					// "users":{"Friends":{"index_2":{"nickname":"test1","head_image":"/uploads/c81e728d9d4c2f636f067f89cc14862c/avatar/20250408/bbdad44f7fe418f0fd677984c2b959ab_big.jpg","message_count":0,
					// "uid":2}},"PrivateLetter":{"index_1":{"nickname":"test1","head_image":"/uploads/c81e728d9d4c2f636f067f89cc14862c/avatar/20250408/bbdad44f7fe418f0fd677984c2b959ab_big.jpg","message_count":0,
					// "uid":2}},"Group":[],"MessageChat":{"index_2":{"nickname":"test1","head_image":"/uploads/c81e728d9d4c2f636f067f89cc14862c/avatar/20250408/bbdad44f7fe418f0fd677984c2b959ab_big.jpg","message_count":0,
					// "uid":2}}}}}
					switch (data.code) {
						case 1: // 用户加入
							this.handleUserJoin(data.data);
							break;
						case 2: // 普通消息
							this.handleMessage(data.data);
							break;
						case 3: //加载历史数据
							// {"code":3,"msg":"success","data":[{"head_image":"/uploads/c4ca4238a0b923820dcc509a6f75849b/avatar/20250228/3dbda5712ed1f3f879a2c32416432be3_middle.png","nickname":"test","chat_id":3,"fromuid":1,"touid":2,"content":"<p>dsd</p>","content_type":"","send_status":1,"create_time":"2026-01-16 09:14:47"},{"head_image":"/uploads/c81e728d9d4c2f636f067f89cc14862c/avatar/20250408/bbdad44f7fe418f0fd677984c2b959ab_big.jpg","nickname":"test1","chat_id":2,"fromuid":2,"touid":1,"content":"<p>asas</p>","content_type":"","send_status":1,"create_time":"2026-01-16 09:14:32"},{"head_image":"/uploads/c81e728d9d4c2f636f067f89cc14862c/avatar/20250408/bbdad44f7fe418f0fd677984c2b959ab_big.jpg","nickname":"test1","chat_id":1,"fromuid":2,"touid":1,"content":"<img style=\"max-width: 150px;\" class=\"massageImgCommon massageImg_jpg\" onclick=\"showMessageImg(this)\" src=\"/uploads/c81e728d9d4c2f636f067f89cc14862c/chatMessage/20251120/efb2e961f020d8f172c81b5120a2e8ea.png\">","content_type":"png","send_status":1,"create_time":"2025-11-20 15:43:38"}],"listtagid":"Friends"}
							this.handleLoadHistory(data.data, data.listtagid);
							break; // 修复：添加缺失的break语句
						case 5: // 房间切换
							this.handleRoomChange(data.data);
							break;
						case 4: // 页面初始化
							this.handleInitPage(data.data);
							break;
						case 8: // 消息撤回
							this.handleRecallMessage(data.data);
							break;
						default:
							console.log('未知消息类型:', data);
					}
				} catch (e) {
					console.log('消息解析失败:', event.data, e);
				}
			},

			// 连接关闭处理
			onClose: function (event) {
				console.log('WebSocket连接已关闭');
				layer.msg('与服务器断开连接，正在尝试重连...', { time: 2000 });
				this.scheduleReconnect();
			},

			// 连接错误处理
			onError: function (event) {
				console.error('WebSocket连接发生错误:', event);
				this.scheduleReconnect();
			},

			// 发送消息
			sendMessage: function (data) {
				if (this.data.wSock && this.data.wSock.readyState === WebSocket.OPEN) {
					this.data.wSock.send(JSON.stringify(data));
				} else {
					console.error('WebSocket未连接，无法发送消息');
					layer.msg('连接异常，请刷新页面重试', { icon: 2 });
				}
			},

			// 开始心跳检测
			startHeartbeat: function () {
				this.stopHeartbeat();
				this.data.heartbeatTimer = setInterval(() => {
					this.sendHeartbeat();
				}, config.heartbeatInterval);
			},

			// 发送心跳
			sendHeartbeat: function () {
				if (this.data.wSock && this.data.wSock.readyState === WebSocket.OPEN) {
					this.sendMessage({ type: 'ping' });
				}
			},

			// 重置心跳
			resetHeartbeat: function () {
				if (this.data.heartbeatTimer) {
					clearInterval(this.data.heartbeatTimer);
					this.startHeartbeat();
				}
			},

			// 停止心跳
			stopHeartbeat: function () {
				if (this.data.heartbeatTimer) {
					clearInterval(this.data.heartbeatTimer);
					this.data.heartbeatTimer = null;
				}
			},

			// 计划重连
			scheduleReconnect: function () {
				if (this.data.lockReconnect) return;

				this.data.lockReconnect = true;
				this.data.reconnectTimer = setTimeout(() => {
					console.log('尝试重连WebSocket...');
					this.initConnection();
					this.data.lockReconnect = false;
				}, config.reconnectInterval);
			},

			// 页面初始化处理
			handleInitPage: function (data) {
				this.initListTags(data.listtags);
				this.initUsers(data.users);
				console.log('页面初始化完成');
			},

			// 初始化列表标签
			initListTags: function (listtags) {
				// 清空现有列表
				$('#chat-list').empty();

				// 添加新的列表项
				$.each(listtags, function (index, tag) {
					const $item = $(`<div class="chat-item" data-listtagid="${tag.listtagid}" onclick="chat.switchChat('${tag.listtagid}')">
                        <div class="chat-info">
                            <div class="chat-title">${tag.listtagname}</div>
                            <div class="chat-time">${tag.last_time || ''}</div>
                        </div>
                        <div class="chat-unread" id="unread-${tag.listtagid}" style="display:none">0</div>
                    </div>`);
					$('#chat-list').append($item);
				});
			},

			// 初始化用户列表
			initUsers: function (users) {
				// 遍历不同类型的聊天标签
				for (const listtagId in users) {
					const userList = users[listtagId];

					// 根据不同类型处理用户列表
					if (Array.isArray(userList)) {
						// 如果是数组类型（如群组）
						$.each(userList, function (index, userInfo) {
							chat.renderConversationItem(listtagId, userInfo, index);
						});
					} else if (typeof userList === 'object') {
						// 如果是对象类型（如私信、好友）
						for (const userId in userList) {
							const userInfo = userList[userId];
							chat.renderConversationItem(listtagId, userInfo, userId);
						}
					}
				}
			},

			// 渲染对话项目
			renderConversationItem: function (listtagId, userInfo, identifier) {
				// 确保userInfo包含必要的字段
				const nickname = userInfo.nickname || '未知用户';
				const headImage = userInfo.head_image || '/static/chat/images/default_avatar.png';
				const messageCount = userInfo.message_count || 0;
				const uid = userInfo.uid || identifier;

				// 创建对话项目元素
				const conversationItem = $(`
                    <div class="conversation-item" 
                         data-listtagid="${listtagId}" 
                         data-uid="${uid}"
                         data-nickname="${nickname}"
                         onclick="chat.selectConversation('${listtagId}', ${uid})">
                        <img src="${headImage}" alt="头像" class="avatar">
                        <div class="conversation-info">
                            <div class="conversation-title">${nickname}</div>
                            <div class="conversation-meta">
                                <span class="message-count">消息: ${messageCount}</span>
                            </div>
                        </div>
                        <div class="conversation-actions">
                            <span class="badge unread-count" id="unread-${listtagId}-${uid}" style="display: ${messageCount > 0 ? 'inline-block' : 'none'}">${messageCount}</span>
                        </div>
                    </div>
                `);

				$("#conversationList").append(conversationItem);
			},

			// 获取列表标签名称
			getListTagName: function (listtagId) {
				const tagNames = {
					'PrivateLetter': '私信',
					'Friends': '好友',
					'Group': '群聊',
					'MessageChat': '评论',
					'ChannelMessageChat': '频道评论'
				};

				return tagNames[listtagId] || listtagId; // 修复：正确返回变量名
			},

			// 选择对话
			selectConversation: function (listtagId, uid) {
				// 更新当前聊天的用户和标签
				this.data.listtagid = listtagId;
				this.data.touid = uid;

				// 切换到对应聊天
				this.switchChat(listtagId);

				// 更新选中状态
				$('.conversation-item').removeClass('active');
				$(`.conversation-item[data-listtagid="${listtagId}"][data-uid="${uid}"]`).addClass('active');

				// 如果是私信或好友聊天，可能需要额外的处理
				if (listtagId === 'PrivateLetter' || listtagId === 'Friends') {
					// 请求加载与特定用户的历史消息
					this.loadUserHistory(uid);
				}
			},

			// 选择用户进行聊天
			selectUser: function (listtagId, uid) {
				// 更新当前聊天的用户和标签
				this.data.listtagid = listtagId;
				this.data.touid = uid;

				// 切换到对应聊天
				this.switchChat(listtagId);

				// 请求加载与特定用户的历史消息
				this.loadUserHistory(uid);
			},

			// 加载用户历史消息
			loadUserHistory: function (uid) {
				// 发送请求获取历史消息
				const historyRequest = {
					type: 2, // 假设类型2为请求历史消息
					fromuid: this.data.uid,
					touid: uid,
					listtagid: this.data.listtagid
				};

				this.sendMessage(historyRequest);
			},

			// 处理用户登录成功（接收服务器返回的当前用户信息）
			handleLoginSuccess: function (userData) {
				// 记录当前登录用户信息
				this.data.uid = userData.uid;
				this.data.nickname = userData.nickname;
				this.data.head_image = userData.head_image;
				this.data.blog = userData.blog;
				this.data.status = userData.status;
				this.data.uptime = userData.uptime;

				// 更新界面显示当前用户信息
				this.updateCurrentUserDisplay();

				console.log('用户登录成功:', userData);
			},

			// 更新当前用户信息显示
			updateCurrentUserDisplay: function () {
				// 更新顶部导航栏的用户信息
				$('#current-user-nickname').text(this.data.nickname);
				$('#current-user-avatar').attr('src', this.data.head_image);

				// 如果有其他需要显示当前用户信息的地方，也可以在这里更新
				$('.current-user-info').each(function () {
					const infoType = $(this).data('info-type');
					switch (infoType) {
						case 'nickname':
							$(this).text(chat.data.nickname);
							break;
						case 'avatar':
							$(this).attr('src', chat.data.head_image);
							break;
						case 'status':
							$(this).text(chat.data.status === 1 ? '在线' : '离线');
							break;
					}
				});
			},

			// 处理其他用户加入
			handleUserJoin: function (userData) {
				// 添加新用户到用户列表
				this.addUserToList(userData);

				console.log('用户加入:', userData);
			},

			// 将用户添加到列表
			addUserToList: function (userData) {
				// 检查用户是否已存在于列表中
				const $existingUser = $(`.user-item[data-uid="${userData.uid}"]`);
				if ($existingUser.length === 0) {
					// 创建新用户项
					const $userItem = $(`
                        <div class="user-item" 
                             data-uid="${userData.uid}"
                             data-nickname="${userData.nickname}"
                             data-head-image="${userData.head_image}"
                             onclick="chat.selectUserByUid(${userData.uid})">
                            <img src="${userData.head_image}" alt="头像" class="avatar">
                            <div class="user-info">
                                <div class="user-name">${userData.nickname}</div>
                                <div class="user-status">${userData.status === 1 ? '在线' : '离线'}</div>
                            </div>
                        </div>
                    `);

					// 添加到用户列表
					$('#online-users-list').prepend($userItem);
				} else {
					// 更新现有用户的状态
					$existingUser.find('.user-status').text(userData.status === 1 ? '在线' : '离线');
					$existingUser.find('.avatar').attr('src', userData.head_image);
				}
			},

			// 根据UID选择用户进行聊天
			selectUserByUid: function (uid) {
				// 查找该用户所属的列表标签
				const $userItem = $(`.user-item[data-uid="${uid}"]`);
				const listtagid = $userItem.data('listtagid') || 'PrivateLetter'; // 默认为私信

				this.selectUser(listtagid, uid);
			},

			// 处理普通消息
			handleMessage: function (msgData) {
				// 创建消息发送者对象
				const sender = {
					uid: msgData.fromuid,
					nickname: msgData.nickname,
					head_image: msgData.head_image
				};

				this.addMessageToChat(msgData.content, sender, msgData.listtagid);
				this.playNotificationSound();
				this.updateUnreadCount(msgData.listtagid);
			},

			// 修复：handleLoadHistory函数接收正确的参数
			handleLoadHistory: function (historyData, listtagid) {
				// 确保有listtagid参数
				if (!listtagid) {
					console.error('handleLoadHistory: 缺少listtagid参数');
					return;
				}

				// 检查聊天容器是否存在，不存在则创建
				let chatContainer = $(`#chatLineHolder-${listtagid}`);
				if (chatContainer.length === 0) {
					// 创建聊天容器
					const container = $(`
						<div class="chat-content-inner" id="chatContent-${listtagid}">
							<div class="chat-line-holder" id="chatLineHolder-${listtagid}"></div>
						</div>
					`);
					$('#messagesContainer').append(container);
					chatContainer = $(`#chatLineHolder-${listtagid}`);
				}

				// 清空当前聊天容器
				chatContainer.empty();

				// 遍历历史消息添加到聊天界面
				if (Array.isArray(historyData)) {
					historyData.forEach(msg => {
						// 创建消息发送者对象
						const sender = {
							uid: msg.fromuid,
							nickname: msg.nickname,
							head_image: msg.head_image
						};

						this.addMessageToChat(msg.content, sender, listtagid);
					});
				}

				// 滚动到底部
				this.scrollToBottom(chatContainer);
			},

			// 处理房间切换
			handleRoomChange: function (roomData) {
				this.data.crd = roomData.listtagid;
				console.log('房间切换至:', roomData.listtagid);
			},

			// 处理消息撤回
			handleRecallMessage: function (msgData) {
				// 实现消息撤回逻辑
				console.log('消息撤回:', msgData);
				layer.msg('一条消息已被撤回', { icon: 7, time: 1500 });
			},

			// 修复：addMessageToChat函数中正确判断发送者
			addMessageToChat: function (content, sender, listtagid) {
				// 检查聊天容器是否存在，不存在则创建
				let chatContainer = $(`#chatLineHolder-${listtagid}`);
				if (chatContainer.length === 0) {
					// 创建聊天容器
					const container = $(`
						<div class="chat-content-inner" id="chatContent-${listtagid}">
							<div class="chat-line-holder" id="chatLineHolder-${listtagid}"></div>
						</div>
					`);
					$('#messagesContainer').append(container);
					chatContainer = $(`#chatLineHolder-${listtagid}`);
				}

				// 修复：使用sender.uid而不是sender.id
				const isCurrentUser = sender.uid == this.data.uid;
				const messageClass = isCurrentUser ? 'user-message' : 'ai-message';

				// 创建消息元素
				const messageElement = $(`
					<div class="message ${messageClass}">
						<div class="message-bubble">
							<div class="message-content">${content}</div>
							<div class="message-time">${new Date().toLocaleTimeString()}</div>
						</div>
					</div>
				`);
				console.log('添加消息:', sender.nickname, content);
				$("#messagesContainer").append(messageElement);

				// 滚动到底部
				this.scrollToBottom(chatContainer);
			},

			// 滚动到聊天底部
			scrollToBottom: function (container) {
				if (container && container.length > 0) {
					container.animate({ scrollTop: container[0].scrollHeight }, 300);
				}
			},

			// 更新未读消息数
			updateUnreadCount: function (listtagid) {
				if (this.data.crd != listtagid) { // 只有不在当前聊天窗口才增加未读数
					const $unreadBadge = $(`#unread-${listtagid}`);
					let count = parseInt($unreadBadge.text()) || 0;
					count++;
					$unreadBadge.text(count);
					$unreadBadge.show();
				}
			},

			// 播放通知声音
			playNotificationSound: function () {
				try {
					const audio = new Audio('/static/chat/voices/notify.mp3');
					audio.play().catch(e => console.log('音频播放失败:', e));
				} catch (e) {
					console.log('创建音频失败:', e);
				}
			},

			// 修复：switchChat函数中正确处理聊天容器
			switchChat: function (listtagid) {
				// 检查聊天容器是否存在，不存在则创建
				let chatContainer = $(`#chatLineHolder-${listtagid}`);
				if (chatContainer.length === 0) {
					// 创建聊天容器
					const container = $(`
						<div class="chat-content-inner" id="chatContent-${listtagid}">
							<div class="chat-line-holder" id="chatLineHolder-${listtagid}"></div>
						</div>
					`);
					$('#messagesContainer').append(container);
					chatContainer = $(`#chatLineHolder-${listtagid}`);
				}

				// 隐藏所有聊天容器
				$('.chat-content-inner').hide();

				// 显示目标聊天容器
				$(`#chatContent-${listtagid}`).show();

				// 更新当前聊天ID
				this.data.listtagid = listtagid;
				this.data.crd = listtagid;

				// 更新选中状态
				$('.chat-item').removeClass('active');
				$(`[data-listtagid="${listtagid}"]`).addClass('active');

				// 隐藏未读消息数
				$(`#unread-${listtagid}`).hide();
				$(`#unread-${listtagid}`).text('0');

				// 滚动到底部
				this.scrollToBottom(chatContainer);
			}
		};

		// 初始化
		$(document).ready(function () {
			// 初始化WebSocket连接
			setTimeout(() => {
				if (config.wsserver) {
					chat.initConnection();
				} else {
					layer.msg('WebSocket服务器地址未配置', { icon: 2 });
				}
			}, 1000);

			// 修复：使用正确的按钮ID
			$('#sendButton').on('click', function () {
				improvedSendMessage();
			});

			// 绑定移动端菜单切换
			$('.mobile-back-btn, #mobileToggleMenu').on('click', function () {
				toggleMobileMenu();
			});

			// 绑定键盘快捷键
			setupKeyboardShortcuts();

			// 绑定消息搜索
			$('#searchMessages').on('input', function () {
				searchMessages($(this).val());
			});

			// 绑定表情选择
			$('#emojiPicker').on('click', '.emoji-item', function () {
				insertEmoji($(this).data('emoji'));
			});

			// 绑定消息复制和撤回功能
			setupMessageContextMenu();
		});

		// 修复：改进的消息发送功能
		function improvedSendMessage() {
			// 修复：使用正确的方式获取消息内容
			let content = '';

			// 检查是否有编辑器实例
			if (typeof editor !== 'undefined' && editor && editor.txt) {
				content = editor.txt.html().trim();
			} else {
				// 尝试从消息输入框获取内容
				const $msgInput = $('#msgInput');
				if ($msgInput.length) {
					content = $msgInput.html().trim();
				}
			}

			if (!content || content === '<p><br></p>') {
				layer.msg('请输入消息内容', { icon: 2 });
				return;
			}

			// 修复：使用正确的按钮ID
			const $sendBtn = $('#sendButton');
			if ($sendBtn.hasClass('disabled')) {
				return;
			}

			$sendBtn.addClass('disabled').text('发送中...');

			try {
				const messageData = {
					type: 2,
					content: content,
					fromuid: chat.data.uid,
					touid: chat.data.touid,
					listtagid: chat.data.listtagid
				};

				chat.sendMessage(messageData);

				// 清空编辑器
				if (typeof editor !== 'undefined' && editor && editor.txt) {
					editor.txt.clear();
				} else {
					const $msgInput = $('#msgInput');
					if ($msgInput.length) {
						$msgInput.html('');
					}
				}

				// 更新UI
				setTimeout(() => {
					$sendBtn.removeClass('disabled').text('发送');
				}, 500);
			} catch (e) {
				console.error('发送消息失败:', e);
				layer.msg('发送失败，请重试', { icon: 2 });
				$sendBtn.removeClass('disabled').text('发送');
			}
		}

		// 修复：键盘快捷键设置
		function setupKeyboardShortcuts() {
			// 编辑器区域的快捷键
			$(document).on('keydown', function (e) {
				// 修复：检查是否在消息输入区域内
				if ($(e.target).closest('#msgInput, .message-input').length > 0) {
					// Ctrl+Enter 发送消息
					if (e.ctrlKey && e.key === 'Enter') {
						e.preventDefault();
						improvedSendMessage();
					}
				}
			});
		}

		// 消息搜索功能
		function searchMessages(keyword) {
			const $allMessages = $('.message-content');
			$allMessages.each(function () {
				const $msgEl = $(this);
				const messageText = $msgEl.text();

				if (keyword === '') {
					$msgEl.closest('.message-item').removeClass('highlight-search-result');
				} else if (messageText.toLowerCase().includes(keyword.toLowerCase())) {
					$msgEl.closest('.message-item').addClass('highlight-search-result');
				} else {
					$msgEl.closest('.message-item').removeClass('highlight-search-result');
				}
			});
		}

		// 消息撤回功能
		function recallMessage($messageItem) {
			layer.confirm('确定要撤回这条消息吗？', {
				icon: 3,
				title: '消息撤回'
			}, function (index) {
				const messageData = {
					type: 8, // 消息撤回类型
					messageId: $messageItem.data('message-id'),
					fromuid: chat.data.uid
				};

				chat.sendMessage(messageData);
				layer.close(index);
			});
		}

		// 消息复制功能
		function copyMessageContent(content) {
			if (navigator.clipboard) {
				navigator.clipboard.writeText(content)
					.then(() => {
						layer.msg('已复制到剪贴板', { icon: 1 });
					})
					.catch(err => {
						console.error('复制失败:', err);
						fallbackCopyTextToClipboard(content);
					});
			} else {
				fallbackCopyTextToClipboard(content);
			}
		}

		function fallbackCopyTextToClipboard(text) {
			const $tempTextarea = $('<textarea>');
			$('body').append($tempTextarea);
			$tempTextarea.val(text).select();

			try {
				const successful = document.execCommand('copy');
				if (successful) {
					layer.msg('已复制到剪贴板', { icon: 1 });
				} else {
					layer.msg('复制失败', { icon: 2 });
				}
			} catch (err) {
				console.error('复制失败:', err);
				layer.msg('复制失败', { icon: 2 });
			}
			$tempTextarea.remove();
		}

		// 表情插入功能
		function insertEmoji(emoji) {
			let currentContent = '';

			// 检查是否有编辑器实例
			if (typeof editor !== 'undefined' && editor && editor.txt) {
				currentContent = editor.txt.html();
				editor.txt.html(currentContent + emoji + '&nbsp;');
			} else {
				// 尝试从消息输入框获取内容
				const $msgInput = $('#msgInput');
				if ($msgInput.length) {
					currentContent = $msgInput.html();
					$msgInput.html(currentContent + emoji + '&nbsp;');
				}
			}
		}

		// 设置消息右键菜单
		function setupMessageContextMenu() {
			$(document).on('contextmenu', '.message', function (e) {
				e.preventDefault();

				const $messageItem = $(this);
				const messageContent = $messageItem.find('.message-content').text();

				// 移除之前的菜单
				$('.message-context-menu').remove();

				const $contextMenu = $(`
                    <div class="message-context-menu" style="position:fixed;top:${e.pageY}px;left:${e.pageX}px;z-index:9999;background:#fff;border:1px solid #ddd;border-radius:4px;box-shadow:0 2px 10px rgba(0,0,0,0.1);padding:5px;">
                        <div class="context-menu-item" onclick="copyMessageContent('${messageContent.replace(/'/g, "\'")}')" style="padding:8px;cursor:pointer;border-bottom:1px solid #eee;">复制消息</div>
                        <div class="context-menu-item" onclick="recallMessage($(this).closest('.message'))" style="padding:8px;cursor:pointer;">撤回消息</div>
                    </div>
                `);

				$('body').append($contextMenu);

				// 点击其他地方关闭菜单
				$(document).one('click', function () {
					$('.message-context-menu').remove();
				});
			});
		}

		// 修复：移动端菜单切换
		function toggleMobileMenu() {
			// 修复：使用窗口宽度检测移动端
			const isMobile = window.innerWidth <= 768;

			if (isMobile) {
				const $menuPanel = $('#menuPanel');
				const $contentPanel = $('.content-panel');

				if ($menuPanel.hasClass('active')) {
					$menuPanel.removeClass('active');
					$contentPanel.show();
				} else {
					$menuPanel.addClass('active');
					$contentPanel.hide();
				}
			} else {
				// 桌面端处理
				$('#menuPanel').toggleClass('collapsed');
				$('.content-panel').toggleClass('expanded');
			}
		}

		// 响应式处理
		function handleResize() {
			if (window.innerWidth <= 768) {
				$('#mobileToggleMenu').show();
			} else {
				$('#mobileToggleMenu').hide();
				$('#menuPanel').show();
				$('.content-panel').show();
			}
		}

		// 监听窗口大小变化
		$(window).on('resize', handleResize);
		handleResize(); // 初始化
	</script>
</body>

</html>
</body>

</html>