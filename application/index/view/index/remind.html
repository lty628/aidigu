{include file='index/header' /}
<style>
    .remind-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .remind-tabs {
        display: flex;
        flex-wrap: wrap;
        border-bottom: 1px solid #eee;
        margin-bottom: 20px;
    }
    
    .remind-tab {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        margin-right: 5px;
        margin-bottom: 5px;
        border-radius: 4px;
    }
    
    .remind-tab.active {
        border-bottom: 3px solid #1E9FFF;
        color: #1E9FFF;
        background: #f0f8ff;
    }
    
    .remind-item {
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .remind-header {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .remind-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
    }
    
    .remind-user {
        font-weight: bold;
        color: #333;
    }
    
    .remind-content {
        margin-left: 50px;
    }
    
    .remind-text {
        color: #666;
        margin-bottom: 10px;
        line-height: 1.5;
    }
    
    .remind-time {
        font-size: 12px;
        color: #999;
        text-align: right;
    }
    
    .remind-actions {
        text-align: right;
        margin-top: 10px;
    }
    
    .remind-actions button {
        margin-left: 10px;
        padding: 5px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        cursor: pointer;
        font-size: 12px;
    }
    
    .remind-actions button:hover {
        background: #f5f5f5;
    }
    
    .remind-actions .read-btn {
        color: #1E9FFF;
    }
    
    .remind-actions .view-btn {
        color: #5FB878;
    }
    
    .no-data {
        text-align: center;
        color: #999;
        padding: 40px;
    }
    
    .loading {
        text-align: center;
        padding: 20px;
        color: #999;
    }
    
    .fade-out {
        opacity: 0;
        transition: opacity 0.3s ease;
    }
</style>

<div class="main">
    <div class="contents">
        <div class="remind-container">
            <h2>提醒</h2>
            
            <div class="remind-tabs">
                <div class="remind-tab active" data-type="all">全部</div>
                <div class="remind-tab" data-type="1">评论</div>
                <div class="remind-tab" data-type="2">回复</div>
                <div class="remind-tab" data-type="3">频道评论</div>
                <div class="remind-tab" data-type="4">频道回复</div>
                <div class="remind-tab" data-type="5">关注</div>
                <div class="remind-tab" data-type="7">@提及</div>
                <div class="remind-tab" data-type="8">收藏</div>
            </div>
            
            <div id="remindList">
                <div class="loading">加载中...</div>
            </div>
            
            <div id="loadMore" style="text-align: center; padding: 20px; display: none;">
                <button onclick="loadMoreReminders()" class="layui-btn">加载更多</button>
            </div>
        </div>
    </div>
    
    {if $userInfo.isSiteUser}
        {include file='index/sidebar_index' /}
    {else}
        {include file='index/sidebar_user' /}
    {/if}
</div>

{include file='index/footer' /}

<script>
let currentPage = 1;
let currentType = 'all';
let hasMore = true;

$(function() {
    loadReminders(currentType, 1);
    
    // 标签页切换
    $('.remind-tab').on('click', function() {
        const type = $(this).data('type');
        if (currentType !== type) {
            $('.remind-tab').removeClass('active');
            $(this).addClass('active');
            currentType = type;
            currentPage = 1;
            hasMore = true;
            $('#remindList').html('<div class="loading">加载中...</div>');
            loadReminders(type, 1);
        }
    });
});

function loadReminders(type, page) {
    $.ajax({
        type: "GET",
        url: "{:url('/index/ajax/getRemind')}",
        data: { 
            page: page,
            type: type === 'all' ? '' : type
        },
        dataType: "json",
        success: function(response) {
            if (response.status === 1 && response.data) {
                renderReminders(response.data.data, page === 1);
                hasMore = response.data.count === 20; // 假设每页20条，如果返回的数量等于每页数量则可能还有更多
                
                if (hasMore) {
                    $('#loadMore').show();
                } else {
                    $('#loadMore').hide();
                }
            } else {
                if (page === 1) {
                    $('#remindList').html('<div class="no-data">暂无提醒</div>');
                }
                $('#loadMore').hide();
            }
        },
        error: function() {
            if (page === 1) {
                $('#remindList').html('<div class="no-data">加载失败，请刷新重试</div>');
            }
        }
    });
}

function renderReminders(reminders, isFirstPage) {
    let html = '';
    
    if (reminders.length === 0) {
        html = '<div class="no-data">暂无提醒</div>';
    } else {
        reminders.forEach(function(item) {
            html += buildReminderItem(item);
        });
    }
    
    if (isFirstPage) {
        $('#remindList').html(html);
    } else {
        $('#remindList').append(html);
    }
}

function buildReminderItem(item) {
    // 根据提醒类型确定显示文本
    let typeText = '';
    switch(parseInt(item.type)) {
        case 1:
            typeText = '评论了你的微博';
            break;
        case 2:
            typeText = '回复了你的微博';
            break;
        case 3:
            typeText = '评论了你的频道';
            break;
        case 4:
            typeText = '回复了你的频道评论';
            break;
        case 5:
            typeText = '关注了你';
            break;
        case 6:
            typeText = '取消关注了你';
            break;
        case 7:
            typeText = '在内容中提到了你';
            break;
        case 8:
            typeText = '收藏了你的微博';
            break;
        case 9:
            typeText = '收藏了你的频道微博';
            break;
        default:
            typeText = item.note || '有新的互动';
    }
    
    // 格式化时间
    const timeString = formatTime(item.ctime);
    
    // 获取内容预览，优先使用特定字段
    let contentPreview = '';
    if (item.content_preview) {
        contentPreview = item.content_preview;
    } else if (item.msg_contents) {
        contentPreview = item.msg_contents;
    } else if (item.comment_contents) {
        contentPreview = item.comment_contents;
    } else if (item.reply_contents) {
        contentPreview = item.reply_contents;
    }
    
    // 构建提醒项HTML
    return `
    <div class="remind-item" data-id="${item.reminder_id}">
        <div class="remind-header">
            <img src="${item.from_head_image || '/static/images/default_avatar.png'}" class="remind-avatar" alt="${item.from_nickname}">
            <div class="remind-user">${item.from_nickname}</div>
        </div>
        <div class="remind-content">
            <div class="remind-text">
                ${typeText}
                ${contentPreview ? '：<br><span style="color: #333;">' + contentPreview + '</span>' : ''}
            </div>
            <div class="remind-time">${timeString}</div>
            <div class="remind-actions">
                <button class="read-btn" onclick="markAsRead(${item.reminder_id})">标记已读</button>
                <button class="view-btn" onclick="viewDetail(${item.type}, ${item.uk_id || item.msg_id || 0}, ${item.reminder_id})">查看</button>
            </div>
        </div>
    </div>
    `;
}

function formatTime(timestamp) {
    const date = new Date(timestamp * 1000);
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    const dayDiff = Math.floor(diff / (1000 * 60 * 60 * 24));
    
    if (dayDiff === 0) {
        // 今天
        return date.getHours() + ':' + (date.getMinutes() < 10 ? '0' : '') + date.getMinutes();
    } else if (dayDiff === 1) {
        return '昨天 ' + date.getHours() + ':' + (date.getMinutes() < 10 ? '0' : '') + date.getMinutes();
    } else {
        return (date.getMonth() + 1) + '-' + date.getDate();
    }
}

function markAsRead(id) {
    // 添加淡出效果
    const itemElement = $(`.remind-item[data-id="${id}"]`);
    itemElement.addClass('fade-out');
    
    // 等待动画完成后移除元素
    setTimeout(function() {
        itemElement.fadeOut();
    }, 300);
    
    // 发送请求标记为已读
    $.ajax({
        type: "POST",
        url: "/index/ajax/markRead", // 新增一个标记已读的API接口
        data: { id: id },
        dataType: "json",
        success: function(response) {
            if (response.code !== 0) {
                // 如果失败，恢复元素显示
                itemElement.removeClass('fade-out').show();
                alert(response.msg || '操作失败');
            } else {
                // 成功则更新头部提醒计数
                updateHeaderRemindCount();
            }
        },
        error: function() {
            // 如果网络错误，恢复元素显示
            itemElement.removeClass('fade-out').show();
            alert('网络错误，请重试');
        }
    });
}

function viewDetail(type, targetId, reminderId) {
    let url = '';
    
    switch(parseInt(type)) {
        case 1: // 评论
        case 2: // 回复
        case 7: // @提及
        case 8: // 收藏微博
            url = `/index/${loginUserInfo.blog}/message/${targetId}`;
            break;
        case 3: // 频道评论
        case 4: // 频道回复
        case 9: // 收藏频道微博
            url = `/tools/channel/message/${targetId}`;
            break;
        case 5: // 关注
        case 6: // 取消关注
            url = `/index/${loginUserInfo.blog}/`;
            break;
        default:
            url = `/index/${loginUserInfo.blog}/message/${targetId}`;
    }
    
    // 标记为已读
    markAsRead(reminderId);
    
    // 跳转到详情页
    window.location.href = url;
}

function loadMoreReminders() {
    if (!hasMore) return;
    
    currentPage++;
    loadReminders(currentType, currentPage);
}

function updateHeaderRemindCount() {
    // 更新头部的提醒计数
    $.ajax({
        type: "GET",
        url: "/index/ajax/checkRemind",
        dataType: "json",
        success: function(response) {
            if (response.status === 1 && response.data) {
                if (response.data.messageRemind) {
                    $('#checkmessageRemind').show();
                } else {
                    $('#checkmessageRemind').hide();
                }
                
                if (response.data.chatRemind) {
                    $('#checkRemind').show();
                } else {
                    $('#checkRemind').hide();
                }
            }
        }
    });
}

// 滚动加载更多
$(window).scroll(function() {
    if ($(window).scrollTop() + $(window).height() >= $(document).height() - 100) {
        loadMoreReminders();
    }
});

// 添加标记已读的API接口
function markRead(id) {
    $.ajax({
        type: "POST",
        url: "{:url('/index/index/markRead')}", // 使用当前控制器的标记已读方法
        data: { id: id },
        dataType: "json",
        success: function(response) {
            if (response.status === 1) {
                updateHeaderRemindCount();
            }
        }
    });
}
</script>