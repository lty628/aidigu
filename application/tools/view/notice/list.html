<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>消息提醒 - 嘀咕</title>
  <link href="/static/layui/css/layui.css" rel="stylesheet">
  <style>
    .reminder-item {
      padding: 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: flex-start;
    }
    .reminder-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 12px;
      flex-shrink: 0;
    }
    .reminder-content {
      flex: 1;
    }
    .reminder-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    .reminder-nickname {
      font-weight: bold;
      color: #333;
    }
    .reminder-type {
      font-size: 12px;
      padding: 2px 6px;
      background-color: #f0f0f0;
      border-radius: 3px;
      color: #666;
    }
    .reminder-body {
      color: #666;
      margin-bottom: 8px;
      line-height: 1.5;
    }
    .reminder-footer {
      display: flex;
      justify-content: space-between;
      color: #999;
      font-size: 12px;
    }
    .reminder-actions {
      text-align: right;
    }
    .reminder-actions button {
      margin-left: 5px;
      font-size: 12px;
    }
    .unread {
      background-color: #f9f9f9;
    }
    .read {
      background-color: #fff;
    }
    .content-preview {
      margin: 8px 0;
      padding: 8px;
      background-color: #f8f9fa;
      border-radius: 4px;
      color: #555;
      font-size: 13px;
    }
    .notification-badge {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #ff4757;
      margin-left: 5px;
    }
  </style>
</head>

<body class="main_body white">
  <div class="layui-layout">
    <div style="padding: 16px;">
      <div class="layui-row">
        <div class="layui-col-md12">
          <div class="layui-tab layui-tab-brief" lay-filter="reminderTab">
            <ul class="layui-tab-title">
              <li class="layui-this" data-type="">全部提醒</li>
              <li data-type="1">评论提醒</li>
              <li data-type="2">回复提醒</li>
              <li data-type="3">频道评论</li>
              <li data-type="4">频道回复</li>
              <li data-type="5">关注提醒</li>
              <li data-type="7">@提及</li>
              <li data-type="8">收藏提醒</li>
            </ul>
            <div class="layui-tab-content">
              <div class="layui-tab-item layui-show">
                <div class="reminder-list-container">
                  <table class="layui-hide" id="reminderTable" lay-filter="reminderTable"></table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/static/layui/layui.js"></script>
  <script language="javascript" type="text/javascript" src="/static/common/js/index.js?22"></script>
  <script>
    layui.use(['table', 'element'], function () {
      var table = layui.table;
      var element = layui.element;
      var $ = layui.$;
      
      // 初始化提醒列表
      var currentType = '';
      renderReminderTable(currentType);

      // 切换标签页
      element.on('tab(reminderTab)', function(data) {
        currentType = $(this).data('type') || '';
        renderReminderTable(currentType);
      });

      // 渲染提醒表格
      function renderReminderTable(type) {
        table.render({
          elem: '#reminderTable',
          url: '/tools/notice/getListNew', // 新的API端点
          where: { type: type },
          toolbar: false,
          defaultToolbar: false,
          height: 'full-100', // 最大高度减去其他容器已占有的高度差
          lineStyle: 'height: auto;',
          cellMinWidth: 80,
          page: true,
          limits: [10, 20, 30, 50],
          limit: 20,
          cols: [[
            {
              field: 'reminder_info', 
              title: '提醒详情', 
              width: '65%',
              templet: function(d) {
                var statusClass = d.status === 0 ? 'unread' : 'read';
                var statusMark = d.status === 0 ? '<span class="notification-badge"></span>' : '';
                
                var avatar = d.extra && d.extra.from_head_image ? d.extra.from_head_image : '/static/images/default_avatar.png';
                var nickname = d.extra && d.extra.from_nickname ? d.extra.from_nickname : '未知用户';
                var typeText = getReminderTypeText(d.type);
                var note = d.note || '你有一条新提醒';
                
                var contentPreview = '';
                if (d.extra && (d.extra.msg_contents || d.extra.comment_contents || d.extra.reply_contents)) {
                  contentPreview = '<div class="content-preview">';
                  if (d.extra.msg_contents) {
                    contentPreview += '<div><strong>主题:</strong> ' + d.extra.msg_contents + '</div>';
                  }
                  if (d.extra.comment_contents) {
                    contentPreview += '<div><strong>评论:</strong> ' + d.extra.comment_contents + '</div>';
                  }
                  if (d.extra.reply_contents) {
                    contentPreview += '<div><strong>回复:</strong> ' + d.extra.reply_contents + '</div>';
                  }
                  contentPreview += '</div>';
                }
                
                var blogLink = d.extra && d.extra.from_blog ? '/'+d.extra.from_blog : 'javascript:;';
                
                return `
                  <div class="reminder-item ${statusClass}">
                    <img src="${avatar}" class="reminder-avatar" onerror="this.src='/static/images/default_avatar.png'">
                    <div class="reminder-content">
                      <div class="reminder-header">
                        <a href="${blogLink}" class="reminder-nickname">${nickname}</a>
                        <span class="reminder-type">${typeText}${statusMark}</span>
                      </div>
                      <div class="reminder-body">${note}</div>
                      ${contentPreview}
                      <div class="reminder-footer">
                        <span>${formatTimestamp(d.ctime)}</span>
                      </div>
                    </div>
                  </div>
                `;
              }
            },
            { 
              field: 'actions', 
              title: '操作', 
              width: '35%',
              align: 'right',
              templet: function(d) {
                var viewUrl = getViewUrl(d.type, d.reminder_id, d.extra.msg_id, d.extra.cid, d.extra.rid, d.extra.channel_id, d.extra.from_blog);
                var actionButtons = `
                  <div class="reminder-actions">
                    <a href="${viewUrl}" target="_blank" class="layui-btn layui-btn-xs">查看</a>
                    ${d.status === 0 ? 
                      `<a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="markRead">标记已读</a>` : 
                      `<a class="layui-btn layui-btn-xs layui-btn-normal">已读</a>`
                    }
                    <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="delete">删除</a>
                  </div>
                `;
                return actionButtons;
              }
            }
          ]]
        });
      }

      // 获取提醒类型文本
      function getReminderTypeText(type) {
        var types = {
          1: '评论',
          2: '回复', 
          3: '频道评论',
          4: '频道回复',
          5: '关注',
          6: '取消关注',
          7: '@提及',
          8: '收藏微博',
          9: '收藏频道'
        };
        return types[type] || '其他';
      }

      // 格式化时间戳
      function formatTimestamp(timestamp) {
        if (!timestamp) return '';
        var date = new Date(timestamp * 1000);
        var year = date.getFullYear();
        var month = String(date.getMonth() + 1).padStart(2, '0');
        var day = String(date.getDate()).padStart(2, '0');
        var hours = String(date.getHours()).padStart(2, '0');
        var minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}`;
      }

      // 获取查看链接
      function getViewUrl(type, reminderId, msgId, cid, rid, channelId, fromBlog) {
        // 根据提醒类型构建不同的查看链接
        switch(parseInt(type)) {
          case 1: // 评论
          case 2: // 回复
          case 7: // @提及
              var blog = '{$userInfo.blog}';
              var uri = `msgId=${msgId}&cid=${cid}&rid=${rid}&reminderId=${reminderId}`;
              uri = base64Encode(uri);
              url = `/${blog}/message/${uri}`;
              break;
          case 3: // 频道评论
          case 4: // 频道回复
          // base64Encode('channelId=' + data[i].channel_id + '&msgId=' + data[i].msg_id) 
              url = `/channel/${base64Encode('channelId=' + channelId + '&msgId=' + msgId+'&cid='+cid+'&rid='+rid+'&reminderId='+reminderId)}`; // 或者跳转到频道详情页
              // console.log('channelId=' + channelId + '&msgId=' + msgId+'&cid='+cid+'&rid='+rid+'&reminderId='+reminderId);
              // return false
              break;
          case 5: // 关注
          case 6:
              url = `/${fromBlog}/own/`; // 跳转到关注者主页
              break;
          case 8: // 收藏微博
              var blog = '{$userInfo.blog}';
              var uri = `msgId=${msgId}&reminderId=${reminderId}`;
              uri = base64Encode(uri);
              url = `/${blog}/message/${uri}`;
              break;
          case 9: // 收藏频道微博
              url = `/index/index/msgdetail/id/${msgId}`;
              break;
          default:
              url = `/index/index/msgdetail/id/${msgId}`;
        }
        return url;
      }

      // 监听工具条事件
      table.on('tool(reminderTable)', function(obj) {
        var data = obj.data;
        var layEvent = obj.event;

        if (layEvent === 'markRead') {
          markAsRead(data.id);
        } else if (layEvent === 'delete') {
          deleteReminder(data.id);
        }
      });

      // 标记为已读
      function markAsRead(id) {
        layer.confirm('确定标记为已读吗？', function(index) {
          $.ajax({
            type: "POST",
            url: "/tools/notice/markRead",
            data: { 'id': id },
            dataType: "json",
            success: function(res) {
              layer.msg(res.msg);
              if (res.code == 0) {
                table.reload('reminderTable');
              }
            },
            error: function() {
              layer.msg('操作失败，请稍后重试');
            }
          });
          layer.close(index);
        });
      }

      // 删除提醒
      function deleteReminder(id) {
        layer.confirm('确定删除此提醒吗？', function(index) {
          $.ajax({
            type: "POST",
            url: "/tools/notice/delete",
            data: { 'id': id },
            dataType: "json",
            success: function(res) {
              layer.msg(res.msg);
              if (res.code == 0) {
                table.reload('reminderTable');
              }
            },
            error: function() {
              layer.msg('删除失败，请稍后重试');
            }
          });
          layer.close(index);
        });
      }

      // 刷新提醒数量
      function refreshReminderCount() {
        $.ajax({
          type: "GET",
          url: "/tools/notice/count",
          dataType: "json",
          success: function(res) {
            if (res.code == 0) {
              // 更新页面上的提醒数量显示
              $('.layui-tab-title .layui-this').find('span').remove();
              if (res.count > 0) {
                $('.layui-tab-title .layui-this').append(`<span class="layui-badge">${res.count}</span>`);
              }
            }
          }
        });
      }

      // 页面加载完成后刷新提醒数量
      refreshReminderCount();
    });
  </script>
</body>

</html>