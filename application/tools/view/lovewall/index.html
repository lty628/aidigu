<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡¨ç™½å¢™ - çˆ±å˜€å’•</title>
    <link rel="stylesheet" href="/static/layui/css/layui.css">
    <style>
        /* å…¨å±€æ ·å¼é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* åŠ¨æ€æ¸å˜èƒŒæ™¯ */
        body {
            background: linear-gradient(-45deg, #ffafbd, #ffc3a0, #a8edea, #fed6e3);
            background-size: 400% 400%;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        /* ç²’å­èƒŒæ™¯æ•ˆæœ */
        .particle-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: rgba(255, 107, 107, 0.3);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px) rotate(0deg);
                opacity: 0.8;
            }
            50% {
                transform: translateY(-30px) rotate(180deg);
                opacity: 0.4;
            }
        }

        /* ä¸»å®¹å™¨ */
        .love-wall-container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            min-height: 100vh;
        }

        /* é¡µå¤´ */
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            padding: 40px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 15px;
            font-weight: 700;
            letter-spacing: 2px;
        }

        .header p {
            font-size: 1.3em;
            opacity: 0.95;
            line-height: 1.6;
        }

        /* å‘å¸ƒæŒ‰é’® */
        .publish-btn-container {
            text-align: center;
            margin-bottom: 50px;
        }

        .publish-btn {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e, #ffd93d);
            background-size: 200% 200%;
            border: none;
            color: white;
            font-weight: bold;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 50px;
            box-shadow: 0 6px 25px rgba(255, 107, 107, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
            animation: gradientButton 3s ease infinite;
        }

        @keyframes gradientButton {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .publish-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 35px rgba(255, 107, 107, 0.6);
        }

        .publish-btn:active {
            transform: translateY(2px);
        }

        /* è¡¨ç™½å¢™å®¹å™¨ */
        .confession-wall {
            position: relative;
            min-height: 700px;
            width: 100%;
            margin: 20px 0;
            padding: 20px;
        }

        /* è¡¨ç™½å¡ç‰‡ */
        .confession-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 25px;
            position: absolute;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 300px;
            transform-origin: center;
            overflow: hidden;
        }

        .confession-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #ff6b6b, #ff8e8e);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .confession-card:hover {
            transform: scale(1.1) rotate(0deg);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.25);
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
        }

        .confession-card:hover::before {
            transform: scaleX(1);
        }

        /* å¡ç‰‡å¤´éƒ¨ */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 2px dashed #ffd3d3;
        }

        .publisher {
            font-weight: bold;
            color: #ff6b6b;
            font-size: 1em;
        }

        .time {
            color: #999;
            font-size: 0.85em;
        }

        /* è¡¨ç™½å¯¹è±¡ */
        .to-name {
            font-size: 1.4em;
            color: #ff6b6b;
            margin: 15px 0;
            font-weight: bold;
            text-align: center;
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* è¡¨ç™½å†…å®¹ */
        .content {
            font-size: 1.05em;
            line-height: 1.8;
            color: #333;
            white-space: pre-wrap;
            max-height: 180px;
            overflow-y: auto;
            padding-right: 5px;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        .content::-webkit-scrollbar {
            width: 6px;
        }

        .content::-webkit-scrollbar-track {
            background: rgba(255, 107, 107, 0.1);
            border-radius: 3px;
        }

        .content::-webkit-scrollbar-thumb {
            background: rgba(255, 107, 107, 0.5);
            border-radius: 3px;
        }

        .content::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 107, 107, 0.7);
        }

        /* åŒ¿åæ ‡ç­¾ */
        .anonymous-tag {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            margin-left: 8px;
            display: inline-block;
            font-weight: 600;
        }

        /* é¡µè„š */
        .footer {
            text-align: center;
            margin-top: 60px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 1em;
            padding: 30px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* æ—‹è½¬æ ·å¼ */
        .rotate-1 {
            transform: rotate(-4deg);
        }

        .rotate-2 {
            transform: rotate(3deg);
        }

        .rotate-3 {
            transform: rotate(-2deg);
        }

        .rotate-4 {
            transform: rotate(1deg);
        }

        .rotate-5 {
            transform: rotate(-3deg);
        }

        .rotate-6 {
            transform: rotate(2deg);
        }

        /* ç¾åŒ–åçš„å¼¹çª—æ ·å¼ */
        .publish-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .popup-content {
            background: linear-gradient(135deg, #fff5f5, #ffecec, #fffaf0);
            border-radius: 25px;
            width: 90%;
            max-width: 550px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(255, 107, 107, 0.4);
            position: relative;
            border: 3px solid #ffb6c1;
            animation: popupShow 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            /* ç¡®ä¿å¼¹çª—å†…å®¹ä¸æº¢å‡º */
            max-height: 90vh;
            overflow-y: auto;
            /* ç¡®ä¿åœ¨æ‰€æœ‰æµè§ˆå™¨ä¸­éƒ½èƒ½æ­£ç¡®å±…ä¸­ */
            margin: 100px auto;
        }

        @keyframes popupShow {
            from {
                opacity: 0;
                transform: scale(0.7) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 32px;
            cursor: pointer;
            color: #ff6b6b;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
            background: rgba(255, 107, 107, 0.1);
        }

        .close-btn:hover {
            background: rgba(255, 107, 107, 0.2);
            transform: rotate(90deg);
        }

        .popup-title {
            text-align: center;
            color: #ff6b6b;
            margin-bottom: 40px;
            font-size: 2.2em;
            font-weight: bold;
            position: relative;
            letter-spacing: 1px;
        }

        .popup-title::after {
            content: '';
            display: block;
            width: 70px;
            height: 4px;
            background: linear-gradient(90deg, #ff6b6b, #ff8e8e);
            margin: 15px auto;
            border-radius: 4px;
        }

        /* è¡¨å•æ ·å¼ */
        .layui-form-item {
            margin-bottom: 30px;
        }

        .layui-form-label {
            color: #ff6b6b;
            font-weight: bold;
            width: 100px;
            font-size: 1.1em;
        }

        .layui-input-block {
            margin-left: 20px;
        }

        .layui-input,
        .layui-textarea {
            border: 3px solid #ffd3d3;
            border-radius: 15px;
            padding: 15px 20px;
            transition: all 0.3s ease;
            font-size: 1.05em;
            background: rgba(255, 255, 255, 0.8);
        }

        .layui-input:focus,
        .layui-textarea:focus {
            border-color: #ff6b6b;
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.4);
            background: rgba(255, 255, 255, 0.95);
        }

        .layui-textarea {
            min-height: 150px;
            resize: vertical;
            line-height: 1.8;
        }

        /* æäº¤æŒ‰é’® */
        .submit-btn {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            border: none;
            color: white;
            font-weight: bold;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 50px;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.6);
        }

        /* åŠ è½½æ›´å¤š */
        #load-more-container {
            text-align: center;
            padding: 30px;
            display: none;
        }

        #load-more-container .layui-icon {
            font-size: 2em;
            color: #ff6b6b;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1024px) {
            .confession-card {
                width: 260px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header h1 {
                font-size: 2.2em;
            }

            .header p {
                font-size: 1.1em;
            }

            .confession-wall {
                padding: 10px;
            }

            .confession-card {
                width: 240px;
                padding: 20px;
            }

            .popup-content {
                padding: 35px 25px;
            }

            .layui-form-label {
                width: 90px;
            }

            .layui-input-block {
                margin-left: 120px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 25px 15px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .publish-btn {
                padding: 12px 30px;
                font-size: 1.1em;
            }

            .confession-card {
                width: calc(100% - 20px);
                position: relative !important;
                margin-bottom: 20px !important;
                transform: none !important;
            }

            .confession-card:hover {
                transform: scale(1.03) !important;
            }

            .popup-content {
                padding: 30px 20px;
            }

            .layui-form-label {
                width: 100%;
                text-align: center;
            }

            .layui-input-block {
                margin-left: 0;
                margin-top: 10px;
            }
        }
    </style>
</head>

<body>
    <!-- ç²’å­èƒŒæ™¯ -->
    <div class="particle-bg" id="particle-bg"></div>

    <div class="love-wall-container">
        <div class="header">
            <h1>ğŸ’– è¡¨ç™½å¢™</h1>
            <p>åœ¨è¿™é‡Œï¼Œå‹‡æ•¢è¯´å‡ºä½ çš„å¿ƒå£°ï¼Œè®©çˆ±ä¼ é€’</p>
        </div>

        <div class="publish-btn-container">
            <button class="publish-btn" id="publish-btn">
                âœï¸ å‘å¸ƒè¡¨ç™½
            </button>
        </div>

        <div id="confession-wall" class="confession-wall">
            <!-- è¡¨ç™½å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div id="load-more-container" style="display: none;">
            <i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i>
            <span style="margin-left: 10px;">åŠ è½½ä¸­...</span>
        </div>

        <div class="footer">
            <p>Â© 2023 çˆ±å˜€å’•è¡¨ç™½å¢™ | å‹‡æ•¢è¡¨è¾¾ï¼Œä¼ é€’çˆ±æ„</p>
        </div>
    </div>

    <!-- å‘å¸ƒå¼¹çª— -->
    <div class="publish-popup" id="publish-popup">
        <div class="popup-content">
            <span class="close-btn" id="close-btn">&times;</span>
            <h2 class="popup-title">ğŸ’Œ å‘å¸ƒè¡¨ç™½</h2>
            <form class="layui-form" id="publish-form">
                <div class="layui-form-item">
                    <label class="layui-form-label">è¡¨ç™½å¯¹è±¡</label>
                    <div class="layui-input-block">
                        <input type="text" name="to_name" placeholder="è¯·è¾“å…¥å¯¹æ–¹æ˜µç§°" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">è¡¨ç™½å†…å®¹</label>
                    <div class="layui-input-block">
                        <textarea name="content" placeholder="å†™ä¸‹ä½ çš„å¿ƒé‡Œè¯..." class="layui-textarea"></textarea>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">åŒ¿åå‘å¸ƒ</label>
                    <div class="layui-input-block">
                        <input type="checkbox" name="is_anonymous" lay-skin="primary" title="åŒ¿å">
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-input-block">
                        <button type="submit" class="submit-btn" lay-submit lay-filter="publish-submit">
                            ğŸ’ å‘å¸ƒè¡¨ç™½
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <input type="hidden" name="touser" value="{$touser}" id="touser">
    <script src="https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js"></script>
    <script src="/static/layui/layui.js"></script>
    <script>
        const touser = $('#touser').val();
        if (touser) {
            $('#to_name').val(touser);
            $('#publish-popup').show();
        }
        layui.use(['form', 'layer'], function () {
            var form = layui.form;
            var layer = layui.layer;

            // é¡µé¢çŠ¶æ€ç®¡ç†
            var pageState = {
                page: 1,
                limit: 15,
                loading: false,
                hasMore: true,
                totalLoaded: 0,
                allDataCount: 0
            };

            // åˆå§‹åŒ–ç²’å­èƒŒæ™¯
            function initParticles() {
                const particleBg = document.getElementById('particle-bg');
                const particleCount = Math.min(30, Math.floor(window.innerWidth / 100));

                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 6 + 's';
                    particle.style.animationDuration = (Math.random() * 4 + 4) + 's';
                    particleBg.appendChild(particle);
                }
            }

            // åˆå§‹åŒ–å¼¹çª—äº¤äº’
            function initPopup() {
                $('#publish-btn').click(function () {
                    $('#publish-popup').show();
                    setTimeout(() => {
                        $('input[name="to_name"]').focus();
                    }, 100);
                });

                $('#close-btn').click(function () {
                    $('#publish-popup').hide();
                });

                $('#publish-popup').click(function (e) {
                    if (e.target === this) {
                        $('#publish-popup').hide();
                    }
                });

                // è¡¨å•æäº¤
                form.on('submit(publish-submit)', function (data) {
                    // è·å–è¡¨å•æ•°æ®
                    var formData = data.field;
                    
                    // å°†åŒ¿åå¤é€‰æ¡†çš„å€¼è½¬æ¢ä¸º1æˆ–0
                    formData.is_anonymous = formData.is_anonymous ? 1 : 0;

                    console.log('å‡†å¤‡æäº¤æ•°æ®:', formData);

                    // éªŒè¯å¿…å¡«å­—æ®µ
                    if (!formData.to_name) {
                        layer.msg('è¯·è¾“å…¥è¡¨ç™½å¯¹è±¡', { icon: 2, time: 2000 });
                        return false;
                    }

                    if (!formData.content) {
                        layer.msg('è¯·è¾“å…¥è¡¨ç™½å†…å®¹', { icon: 2, time: 2000 });
                        return false;
                    }

                    // å‘é€AJAXè¯·æ±‚
                    $.ajax({
                        url: '/tools/lovewall/publish',
                        type: 'POST',
                        data: formData,
                        dataType: 'json',
                        beforeSend: function () {
                            // æ˜¾ç¤ºåŠ è½½å±‚
                            var loadIndex = layer.load(2, {
                                shade: [0.5, '#fff'],
                                content: 'å‘å¸ƒä¸­...',
                                success: function (layero) {
                                    layero.find('.layui-layer-content').css({
                                        'padding': '0 30px',
                                        'color': '#ff6b6b'
                                    });
                                }
                            });
                        },
                        success: function (res) {
                            // å…³é—­åŠ è½½å±‚
                            layer.closeAll('loading');

                            if (res.code === 0) {
                                layer.msg(res.msg, { icon: 1, time: 2000 });
                                // æ¸…ç©ºè¡¨å•
                                $('#publish-form')[0].reset();
                                form.render('checkbox');
                                // å…³é—­å¼¹çª—
                                $('#publish-popup').hide();
                                // é‡ç½®é¡µé¢çŠ¶æ€å¹¶é‡æ–°åŠ è½½è¡¨ç™½åˆ—è¡¨
                                pageState.page = 1;
                                pageState.totalLoaded = 0;
                                pageState.hasMore = true;
                                window.location.reload();
                            } else {
                                layer.msg(res.msg, { icon: 2, time: 2000 });
                            }
                        },
                        error: function (xhr, status, error) {
                            // å…³é—­åŠ è½½å±‚
                            layer.closeAll('loading');
                            layer.msg('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', { icon: 2, time: 2000 });
                        }
                    });

                    return false; // é˜»æ­¢é»˜è®¤è¡Œä¸º
                });
            }

            // å…¨å±æ™ºèƒ½åˆ†å¸ƒç®—æ³•ï¼Œä¸é™åˆ¶åˆ—æ•°ï¼Œå……åˆ†åˆ©ç”¨å±å¹•ç©ºé—´
            function fullscreenPositioning(cards, containerWidth, containerHeight) {
                const positions = [];
                const cardWidth = 300;
                const cardHeight = 220;
                const padding = 30;
                const maxAttempts = 150;

                // è®¡ç®—å¯ä»¥å®¹çº³çš„æœ€å¤§è¡Œåˆ—æ•°ï¼ˆä¸ä¸¥æ ¼é™åˆ¶ï¼‰
                const maxCols = Math.ceil(containerWidth / (cardWidth + padding));
                const maxRows = Math.ceil(containerHeight / (cardHeight + padding));

                // åˆ›å»ºè™šæ‹Ÿç½‘æ ¼ç”¨äºè·Ÿè¸ªå ç”¨åŒºåŸŸ
                const grid = [];
                for (let i = 0; i < maxRows; i++) {
                    grid[i] = [];
                    for (let j = 0; j < maxCols; j++) {
                        grid[i][j] = false;
                    }
                }

                cards.each(function (index) {
                    let placed = false;
                    let attempts = 0;

                    while (!placed && attempts < maxAttempts) {
                        // åœ¨æ•´ä¸ªå®¹å™¨èŒƒå›´å†…éšæœºç”Ÿæˆä½ç½®
                        let left = Math.random() * (containerWidth - cardWidth - padding);
                        let top = Math.random() * (containerHeight - cardHeight - padding);

                        // ç¡®ä¿ä¸ä¼šè¶…å‡ºè¾¹ç•Œ
                        left = Math.max(padding, Math.min(left, containerWidth - cardWidth - padding));
                        top = Math.max(padding, Math.min(top, containerHeight - cardHeight - padding));

                        // æ£€æŸ¥ä¸å·²æœ‰å¡ç‰‡çš„é‡å æƒ…å†µ
                        let overlap = false;
                        for (let pos of positions) {
                            // è®¡ç®—ä¸¤ä¸ªçŸ©å½¢æ˜¯å¦é‡å 
                            if (!(left > pos.left + cardWidth + padding / 2 ||
                                left + cardWidth + padding / 2 < pos.left ||
                                top > pos.top + cardHeight + padding / 2 ||
                                top + cardHeight + padding / 2 < pos.top)) {
                                overlap = true;
                                break;
                            }
                        }

                        // å¦‚æœæ²¡æœ‰é‡å æˆ–è€…å·²ç»æ˜¯æœ€åä¸€æ¬¡å°è¯•ï¼Œåˆ™æ”¾ç½®å¡ç‰‡
                        if (!overlap || attempts >= maxAttempts - 1) {
                            positions.push({ left, top });
                            $(this).css({
                                left: left + 'px',
                                top: top + 'px'
                            });
                            placed = true;
                        }

                        attempts++;
                    }

                    // å¦‚æœæ‰€æœ‰å°è¯•éƒ½å¤±è´¥äº†ï¼Œå¼ºåˆ¶æ”¾ç½®åœ¨å®‰å…¨ä½ç½®
                    if (!placed) {
                        const safeLeft = Math.random() * (containerWidth - cardWidth - 40) + 20;
                        const safeTop = Math.random() * (containerHeight - cardHeight - 40) + 20;
                        positions.push({ left: safeLeft, top: safeTop });
                        $(this).css({
                            left: safeLeft + 'px',
                            top: safeTop + 'px'
                        });
                    }
                });
            }

            // åŠ è½½è¡¨ç™½åˆ—è¡¨å¹¶æ™ºèƒ½åˆ†å¸ƒæ˜¾ç¤º
            function loadConfessions(isAppend = false) {
                if (pageState.loading || !pageState.hasMore) return;

                pageState.loading = true;
                // åŠ è½½ä¸€é¡µ
                pageState.hasMore = false

                // æ˜¾ç¤ºåŠ è½½æç¤º
                $('#load-more-container').show();

                $.get('/tools/lovewall/getList', {
                    page: pageState.page,
                    limit: pageState.limit
                }, function (res) {
                    if (res.code === 0) {
                        var wall = $('#confession-wall');

                        // è·å–å®¹å™¨å°ºå¯¸ï¼ˆå…¨å±åˆ©ç”¨ï¼‰
                        var containerWidth = $(window).width() - 40; // ç•™ä¸€äº›è¾¹è·

                        // é¢„å®šä¹‰æ—‹è½¬æ ·å¼ç±»
                        var rotateClasses = ['rotate-1', 'rotate-2', 'rotate-3', 'rotate-4', 'rotate-5', 'rotate-6'];

                        // è®°å½•æ–°æ·»åŠ çš„å¡ç‰‡å…ƒç´ ï¼Œç”¨äºåç»­å®šä½
                        var newCards = $();

                        $.each(res.data, function (index, item) {
                            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥å¡ç‰‡ï¼ˆé˜²æ­¢é‡å¤ï¼‰
                            if ($(`.confession-card[data-id="${item.id}"]`).length > 0) {
                                return true; // è·³è¿‡å½“å‰å¾ªç¯
                            }

                            // éšæœºæ—‹è½¬æ ·å¼
                            var rotateClass = rotateClasses[Math.floor(Math.random() * rotateClasses.length)];

                            // éšæœºé¢œè‰²ä¸»é¢˜
                            var colorThemes = [
                                'rgba(255, 235, 238, 0.9)',
                                'rgba(255, 248, 220, 0.9)',
                                'rgba(240, 248, 255, 0.9)',
                                'rgba(255, 240, 245, 0.9)',
                                'rgba(245, 245, 245, 0.9)'
                            ];
                            var bgColor = colorThemes[Math.floor(Math.random() * colorThemes.length)];

                            var cardHtml = `
                                <div class="confession-card ${rotateClass}" 
                                     style="background: ${bgColor};"
                                     data-id="${item.id}">
                                    <div class="card-header">
                                        <div>
                                            <span class="publisher">${item.publisher}</span>
                                            ${item.is_anonymous == 1 ? '<span class="anonymous-tag">åŒ¿å</span>' : ''}
                                        </div>
                                        <div class="time">${item.create_time_format}</div>
                                    </div>
                                    <div class="to-name">â¤ï¸ è‡´ ${item.to_name}</div>
                                    <div class="content">${item.content}</div>
                                </div>
                            `;

                            var $card = $(cardHtml);
                            wall.append($card);
                            newCards = newCards.add($card);
                        });

                        // å¦‚æœä¸æ˜¯è¿½åŠ æ¨¡å¼ï¼Œæ¸…ç©ºä¹‹å‰çš„å†…å®¹
                        if (!isAppend) {
                            // ç§»é™¤æ—§çš„å¡ç‰‡ï¼Œåªä¿ç•™æ–°æ·»åŠ çš„
                            $('.confession-card').not(newCards).remove();
                        }

                        // æ›´æ–°æ€»æ•°ä¿¡æ¯
                        pageState.allDataCount = res.count;

                        // åŠ¨æ€è®¡ç®—å®¹å™¨é«˜åº¦ï¼Œç¡®ä¿èƒ½å®¹çº³æ‰€æœ‰å¡ç‰‡
                        var baseHeight = $(window).height() - 250;
                        var cardsPerRow = Math.floor(containerWidth / 340); // æ¯è¡Œå¯å®¹çº³å¡ç‰‡æ•°(è€ƒè™‘å¡ç‰‡å®½åº¦+é—´è·)
                        var totalCards = pageState.totalLoaded + res.data.length;
                        var estimatedRows = Math.ceil(totalCards / cardsPerRow);
                        var estimatedHeight = estimatedRows * 280; // æ¯è¡Œé«˜åº¦ä¼°è®¡å€¼

                        // å®¹å™¨é«˜åº¦åº”è¯¥æ˜¯çª—å£é«˜åº¦å’Œä¼°ç®—å†…å®¹é«˜åº¦çš„æœ€å¤§å€¼ï¼Œç¡®ä¿æœ‰è¶³å¤Ÿçš„ç©ºé—´æ”¾ç½®å¡ç‰‡
                        var containerHeight = Math.max(baseHeight, estimatedHeight, 800);

                        wall.css({
                            'height': containerHeight + 'px',
                            'width': '100%'
                        });

                        // æ›´æ–°å·²åŠ è½½æ•°é‡
                        pageState.totalLoaded += res.data.length;

                        // åˆ¤æ–­æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®
                        // pageState.hasMore = pageState.totalLoaded < res.count;

                        // ä½¿ç”¨å…¨å±æ™ºèƒ½åˆ†å¸ƒç®—æ³•å¯¹æ–°å¡ç‰‡è¿›è¡Œå®šä½
                        if (newCards.length > 0) {
                            fullscreenPositioning(newCards, containerWidth, containerHeight);
                        }

                        // ä¸ºæ‰€æœ‰å¡ç‰‡æ·»åŠ ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…åŠŸèƒ½ï¼ˆæ— è®ºæ˜¯å¦è¿½åŠ æ¨¡å¼éƒ½éœ€è¦ç»‘å®šäº‹ä»¶ï¼‰
                        $('.confession-card').off('click').on('click', function () {
                            var content = $(this).find('.content').text();
                            var publisher = $(this).find('.publisher').text();
                            var toName = $(this).find('.to-name').text().replace('â¤ï¸ è‡´ ', '');
                            var time = $(this).find('.time').text();
                            var id = $(this).data('id');

                            // è®¡ç®—åŠ¨æ€å¼¹çª—å¤§å°
                            var maxWidth = $(window).width() > 768 ? '600px' : '90%';
                            var maxHeight = $(window).height() > 768 ? '500px' : '85%';

                            layer.open({
                                type: 1,
                                title: 'ğŸ’ è¡¨ç™½è¯¦æƒ…',
                                area: [maxWidth, maxHeight],
                                shadeClose: true,
                                anim: 5,
                                skin: 'layui-layer-lan',
                                content: `
                                    <div style="padding: 30px; height: 100%; overflow-y: auto;">
                                        <div style="margin-bottom: 25px; color: #ff6b6b; font-weight: bold; font-size: 1.3em; text-align: center;">
                                            â¤ï¸ è‡´ ${toName}
                                        </div>
                                        <div style="margin-bottom: 25px; background: #f8f9fa; padding: 25px; border-radius: 15px; line-height: 2; font-size: 1.1em; white-space: pre-wrap;">
                                            ${content.replace(/\n/g, '<br>')}
                                        </div>
                                        <div style="display: flex; justify-content: space-between; color: #666; font-size: 1em; padding-top: 15px; border-top: 2px dashed #ffd3d3;">
                                            <span>æ¥è‡ª: ${publisher}</span>
                                            <span>${time}</span>
                                        </div>
                                    </div>
                                `,
                                success: function(layero, index) {
                                    // è‡ªå®šä¹‰å¼¹çª—æ ·å¼
                                    layero.find('.layui-layer-title').css({
                                        'background': 'linear-gradient(135deg, #ff6b6b, #ff8e8e)',
                                        'color': '#fff',
                                        'font-weight': 'bold',
                                        'font-size': '1.2em',
                                        'border-radius': '10px 10px 0 0'
                                    });
                                    layero.css('border-radius', '10px');
                                }
                            });
                        });

                        // æ›´æ–°é¡µé¢çŠ¶æ€
                        pageState.page++;
                    }

                    // éšè—åŠ è½½æç¤º
                    $('#load-more-container').hide();
                    pageState.loading = false;
                }, 'json');
            }

            // é‡ç½®å¹¶é‡æ–°åŠ è½½è¡¨ç™½åˆ—è¡¨
            function resetAndLoadConfessions() {
                pageState.page = 1;
                pageState.totalLoaded = 0;
                pageState.hasMore = true;
                loadConfessions(false);
            }

            // æ£€æŸ¥æ˜¯å¦éœ€è¦åŠ è½½æ›´å¤š
            function checkScroll() {
                if (pageState.loading || !pageState.hasMore) return;

                // è·å–é¡µé¢æ»šåŠ¨ä½ç½®
                var scrollTop = $(window).scrollTop();
                var windowHeight = $(window).height();
                var documentHeight = $(document).height();

                // å½“æ»šåŠ¨åˆ°åº•éƒ¨é™„è¿‘æ—¶åŠ è½½æ›´å¤šï¼ˆæå‰1/3å±å¹•é«˜åº¦å¼€å§‹åŠ è½½ï¼‰
                var triggerThreshold = windowHeight / 3;
                if (scrollTop + windowHeight >= documentHeight - triggerThreshold) {
                    loadConfessions(true);
                }
            }

            // èŠ‚æµå¤„ç†çš„æ»šåŠ¨ç›‘å¬
            var throttleTimer = null;
            $(window).on('scroll', function () {
                if (!throttleTimer) {
                    throttleTimer = setTimeout(function () {
                        checkScroll();
                        throttleTimer = null;
                    }, 150); // 150msèŠ‚æµé—´éš”ï¼Œæ›´æµç•…çš„ä½“éªŒ
                }
            });

            // åˆå§‹åŒ–å‡½æ•°
            function init() {
                initParticles();
                initPopup();
                resetAndLoadConfessions();
            }

            // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°å¸ƒå±€
            $(window).on('resize', function () {
                // é˜²æŠ–å¤„ç†ï¼Œé¿å…é¢‘ç¹é‡æ’
                clearTimeout(window.resizeTimeout);
                window.resizeTimeout = setTimeout(function () {
                    resetAndLoadConfessions();
                }, 300);
            });

            // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
            $(document).ready(function () {
                init();
            });
        });
    </script>
</body>

</html>