<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯„è®ºç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/layui/css/layui.css">
    <style>
        body {
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 0;
            /* padding: 20px; */
            min-height: 100vh;
        }

        .comment-container {
            /* max-width: 800px; */
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .comment-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f2f5;
            color: #1d2129;
            position: relative;
        }

        .comment-title::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 50px;
            height: 2px;
            background: linear-gradient(90deg, #007bff, #6c757d);
        }

        .comment-form {
            margin-bottom: 30px;
            background: #fafbfc;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-control {
            width: 96%;
            padding: 12px 15px;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            resize: none;
            font-size: 14px;
            background-color: #fff;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0062cc 100%);
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #0069d9 0%, #005cbf 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid #ccc;
            color: #666;
        }

        .btn-outline:hover {
            background-color: #f8f9fa;
            border-color: #adb5bd;
        }

        .comments-list {
            margin-top: 20px;
        }

        .comment-item {
            border-bottom: 1px solid #f0f2f5;
            padding: 20px 0;
            transition: background-color 0.2s ease;
        }

        .comment-item:last-child {
            border-bottom: none;
        }

        .comment-header-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            align-items: center;
        }

        .user-link {
            text-decoration: none;
            color: #333;
            font-weight: 600;
        }

        .user-link:hover {
            color: #007bff;
        }

        .avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            margin-right: 12px;
            vertical-align: middle;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            font-size: 16px;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .comment-author {
            margin-right: 10px;
            font-size: 14px;
        }

        .comment-time {
            color: #8a9ca4;
            font-size: 12px;
        }

        .comment-content {
            margin: 10px 0;
            padding-left: 55px;
            color: #333;
            line-height: 1.7;
            font-size: 15px;
        }

        .action-buttons {
            margin-top: 12px;
            padding-left: 55px;
        }

        .reply-btn,
        .reply-toggle,
        .delete-btn {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            font-size: 13px;
            padding: 6px 10px;
            margin-right: 12px;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
        }

        .reply-btn:hover,
        .reply-toggle:hover {
            background-color: #f8f9fa;
            color: #0056b3;
            text-decoration: none;
        }

        .delete-btn {
            color: #dc3545;
        }

        .delete-btn:hover {
            background-color: #f8d7da;
            color: #c82333;
        }

        .reply-form {
            margin: 15px 0 15px 55px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            /* border-left: 3px solid #007bff; */
        }

        .replies {
            margin-left: 55px;
            margin-top: 15px;
            background-color: #fafafa;
            border-radius: 8px;
            /* padding: 10px; */
        }

        .replies .comment-item {
            padding: 15px 0;
            border-bottom: 1px dashed #e9ecef;
            /* background-color: white; */
            margin-bottom: 8px;
            border-radius: 6px;
            padding-left: 15px;
            padding-right: 15px;
        }

        .replies .comment-item:last-child {
            border-bottom: none;
        }

        .replies .comment-content {
            padding-left: 50px;
            font-size: 14px;
        }

        .replies .comment-header-info {
margin-bottom: 8px;
        }

        .replies .reply-form {
            margin-left: 0;
        }

        .no-comments,
        .no-replies {
            text-align: center;
            color: #999;
            padding: 30px 0;
            font-size: 14px;
        }

        .pagination {
            margin: 30px 0;
            text-align: center;
        }

        .load-more-replies {
            margin: 15px 0 15px 55px;
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            border: none;
            color: white;
            cursor: pointer;
            font-size: 13px;
            padding: 8px 15px;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
        }

        .load-more-replies:hover {
            background: linear-gradient(135deg, #5a6268 0%, #495057 100%);
            transform: translateY(-1px);
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: #999;
            font-size: 14px;
        }

        .error-message {
            color: #dc3545;
            text-align: center;
            padding: 30px;
            background-color: #f8d7da;
            border-radius: 6px;
            margin: 10px 0;
        }

        .comment-count {
            background-color: #007bff;
color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 5px;
        }

        .highlight {
            animation: highlight 1s ease;
        }

        @keyframes highlight {
            0% { background-color: #fff3cd; }
            100% { background-color: transparent; }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .comment-container {
                padding: 20px;
            }
            
            .comment-content,
            .action-buttons {
                padding-left: 0;
            }
            
            .replies {
                margin-left: 0;
            }
            
            .avatar {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }
            
            .comment-header-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }
    </style>
</head>

<body>
    <div class="comment-container">
        <!-- <h2 class="comment-title">ğŸ’¬ è¯„è®ºäº’åŠ¨</h2> -->

        <!-- è¯„è®ºè¡¨å• -->
        <div class="comment-form">
            <div class="form-group">
                <textarea class="form-control" id="mainContent" rows="4" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."></textarea>
            </div>
            <button class="btn btn-primary" id="submitComment">å‘è¡¨è¯„è®º</button>
        </div>

        <!-- è¯„è®ºåˆ—è¡¨å®¹å™¨ -->
        <div class="comments-list" id="commentsContainer">
            <div class="loading">â³ åŠ è½½ä¸­...</div>
        </div>

        <!-- åˆ†é¡µå®¹å™¨ -->
        <div class="pagination" id="paginationContainer"></div>
    </div>

    <!-- éšè—å­—æ®µ -->
    <input type="hidden" id="msgId" value="{$msgId|default=1}">
    <input type="hidden" id="commentId" value="{$commentId|default=0}">
    <input type="hidden" id="type" value="{$type|default='default'}">
    <input type="hidden" id="currentUid" value="{$currentUid|default=0}">
    <input type="hidden" id="msgUid" value="{$msgUid|default=0}">

    <script src="/static/layui/layui.js"></script>
    <script>
        layui.use(['layer', 'laypage'], function () {
            const layer = layui.layer;
            const laypage = layui.laypage;
            const $ = layui.$;
            // å…¨å±€å˜é‡
            let currentPage = 1;
            const limit = 10; // æ¯é¡µæ˜¾ç¤ºçš„è¯„è®ºæ•°

            // é¡µé¢åŠ è½½å®ŒæˆååŠ è½½è¯„è®º
            $(document).ready(function () {
                loadComments(1);
                bindEvents();
            });

            // ç»‘å®šäº‹ä»¶
            function bindEvents() {
                // æäº¤è¯„è®º
                $('#submitComment').on('click', submitComment);

                // å›å¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼‰
                $(document).on('click', '.reply-btn', function () {
                    const commentId = $(this).data('comment-id');
                    const replyId = $(this).data('reply-id');
                    const replyForm = $('#replyForm-' + commentId);

                    // æ˜¾ç¤ºå›å¤è¡¨å•
                    replyForm.toggle();
                    // å¦‚æœæ˜¯å›å¤æŸæ¡å›å¤ï¼Œåˆ™è®¾ç½®@ç”¨æˆ·
                    if (replyId) {
                        const replyContent = replyForm.find('.reply-content');
                        const replyItem = $(this).closest('.comment-item');
                        const authorName = replyItem.find('.comment-author').text();
                        replyContent.val('@' + authorName + ' ');
                        replyContent.focus();
                    }
                });

                // å–æ¶ˆå›å¤
                $(document).on('click', '.cancel-reply', function () {
                    const commentId = $(this).data('comment-id');
                    $('#replyForm-' + commentId).hide();
                    $('#replyForm-' + commentId + ' .reply-content').val('');
                });

                // å‘é€å›å¤
                $(document).on('click', '.send-reply', function () {
                    const commentId = $(this).data('comment-id');
                    const replyContent = $('#replyForm-' + commentId + ' .reply-content').val();

                    // æå–@ç”¨æˆ·ä¿¡æ¯
                    let touid = $(this).data('touid');


                    sendReply(commentId, replyContent, touid);
                });

                // å±•å¼€/æ”¶èµ·å›å¤
                $(document).on('click', '.reply-toggle', function () {
                    const commentId = $(this).data('comment-id');
                    const repliesContainer = $('#replies-' + commentId);

                    if (repliesContainer.hasClass('collapsed')) {
                        repliesContainer.removeClass('collapsed');
                        $(this).text('æ”¶èµ·å›å¤');

                        // å¦‚æœè¿˜æ²¡æœ‰åŠ è½½è¿‡å›å¤ï¼Œåˆ™åŠ è½½å›å¤
                        if (!repliesContainer.data('loaded')) {
                            // ä½¿ç”¨loadMoreReplieså‡½æ•°ï¼Œå¹¶æ·»åŠ æ ‡è®°è¡¨ç¤ºæ˜¯åˆæ¬¡åŠ è½½
                            repliesContainer.data('initial-load', true);
                            loadMoreReplies(commentId, 1);
                            repliesContainer.data('loaded', true);
                        }
                    } else {
                        repliesContainer.addClass('collapsed');
                        $(this).text('å±•å¼€å›å¤');
                    }
                });

                // åŠ è½½æ›´å¤šå›å¤
                $(document).on('click', '.load-more-replies', function () {
                    const commentId = $(this).data('comment-id');
                    const currentPage = parseInt($(this).data('current-page')) || 0;
                    loadMoreReplies(commentId, currentPage + 1);
                });

                // åˆ é™¤è¯„è®º
                $(document).on('click', '.delete-comment', function () {
                    const commentId = $(this).data('comment-id');
                    deleteComment(commentId);
                });

                // åˆ é™¤å›å¤
                $(document).on('click', '.delete-reply', function () {
                    const replyId = $(this).data('reply-id');
                    const commentId = $(this).data('comment-id');
                    deleteReply(replyId, commentId);
                });
            }

            // åŠ è½½è¯„è®ºåˆ—è¡¨
            function loadComments(page) {
                currentPage = page;
                const msgId = $('#msgId').val() || 1;
                const type = $('#type').val();
                const commentId = $('#commentId').val() || 0;

                $('#commentsContainer').html('<div class="loading">â³ åŠ è½½ä¸­...</div>');

                $.ajax({
                    url: '/tools/comment/getCommentList',
                    method: 'GET',
                    data: {
                        msg_id: msgId,
                        comment_id: commentId,
                        type: type,
                        page: page,
                        limit: limit
                    },
                    success: function (response) {
                        if (response.code === 200) {
                            renderComments(response.data.list, response.data.userList);
                            renderPagination(response.data.total, page, limit);
                        } else {
                            $('#commentsContainer').html('<div class="error-message">åŠ è½½å¤±è´¥: ' + response.msg + '</div>');
                        }
                    },
                    error: function () {
                        $('#commentsContainer').html('<div class="error-message">ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•</div>');
                    }
                });
            }

            // æ¸²æŸ“è¯„è®ºåˆ—è¡¨
            function renderComments(comments, userList) {
                let html = '';

                if (comments.length === 0) {
                    html = '<div class="no-comments">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§ï¼</div>';
                    $('#commentsContainer').html(html);
                    return;
                }

                const currentUid = parseInt($('#currentUid').val()) || 0;

                comments.forEach(function (comment) {
                    const user = userList[comment.fromuid] || { nickname: 'æœªçŸ¥ç”¨æˆ·', head_image: '', blog: '' };
                    const isOwnComment = comment.fromuid == currentUid;

                    const avatar = user.head_image ?
                        `<a href="/${user.blog}/" class="user-link"><img src="${user.head_image}" class="avatar" alt="å¤´åƒ"></a>` :
                        `<a href="/${user.blog}/" class="user-link"><span class="avatar">${user.nickname.charAt(0).toUpperCase()}</span></a>`;

                    html += `
                    <div class="comment-item" data-cid="${comment.cid}">
                        <div class="comment-header-info">
                            <div>
                                ${avatar}
                                <a href="/${user.blog}/" class="user-link comment-author">${user.nickname}</a>
                                ${isOwnComment ? `<button class="delete-btn delete-comment" data-comment-id="${comment.cid}">ğŸ—‘ï¸ åˆ é™¤</button>` : ''}
                            </div>
                            <div class="comment-time">${formatTime(comment.ctime)}</div>
                        </div>
                        <div class="comment-content">
                            ${comment.msg}
                        </div>
                        <div class="action-buttons">
                            <button class="reply-btn" data-touid="${comment.fromuid}" data-comment-id="${comment.cid}">ğŸ’¬ å›å¤</button>
                            ${comment.reply_count > 0 ? `<button class="reply-toggle" data-comment-id="${comment.cid}" data-total-replies="${comment.reply_count}">
                                ğŸ’¬ <span class="comment-count">${comment.reply_count}</span> æ¡å›å¤
                            </button>` : ''}
                        </div>

                        <!-- å›å¤è¡¨å• - é»˜è®¤éšè— -->
                        <div class="reply-form" id="replyForm-${comment.cid}" style="display: none;">
                            <div class="form-group">
                                <textarea class="form-control reply-content" placeholder="è¯·è¾“å…¥å›å¤å†…å®¹..." data-comment-id="${comment.cid}"></textarea>
                            </div>
                            <button class="btn btn-primary send-reply" data-comment-id="${comment.cid}">å‘é€å›å¤</button>
                            <button class="btn btn-outline cancel-reply" style="margin-left: 10px;" data-comment-id="${comment.cid}">å–æ¶ˆ</button>
                        </div>

                        <!-- å›å¤åˆ—è¡¨ -->
                        <div class="replies collapsed" id="replies-${comment.cid}">
                    `;

                    // æ¸²æŸ“relation_reply_idå¯¹åº”çš„å›å¤
                    if (comment.replies && comment.replies.length > 0) {
                        comment.replies.forEach(function (reply, index) {
                            const replyUser = userList[reply.fromuid] || { nickname: 'æœªçŸ¥ç”¨æˆ·', head_image: '', blog: '' };
                            const isOwnReply = reply.fromuid == currentUid;
                            const toUser = userList[reply.touid] ? userList[reply.touid].nickname : '';
                            const replyPrefix = toUser ? `@${toUser}` : '';

                            const replyAvatar = replyUser.head_image ?
                                `<a href="/${replyUser.blog}/" class="user-link"><img src="${replyUser.head_image}" class="avatar" alt="å¤´åƒ"></a>` :
                                `<a href="/${replyUser.blog}/" class="user-link"><span class="avatar">${replyUser.nickname.charAt(0).toUpperCase()}</span></a>`;

                            html += `
                            <div class="comment-item">
                                <div class="comment-header-info">
                                    <div>
                                        ${replyAvatar}
                                        <a href="/${replyUser.blog}/" class="user-link comment-author">${replyUser.nickname}</a>
                                        ${isOwnReply ? `<button class="delete-btn delete-reply" data-reply-id="${reply.cid}" data-comment-id="${comment.cid}">ğŸ—‘ï¸ åˆ é™¤</button>` : ''}
                                    </div>
                                    <div class="comment-time">${formatTime(reply.ctime)}</div>
                                </div>
                                <div class="comment-content">
                                    ${replyPrefix} ${reply.msg}
                                </div>
                                <div class="action-buttons">
                                    <button class="reply-btn" data-comment-id="${comment.cid}" data-reply-id="${reply.cid}">ğŸ’¬ å›å¤</button>
                                </div>
                            </div>
                            `;
                        });

                        // å¦‚æœå›å¤æ•°å¤§äºrelation_reply_idæ•°é‡ï¼Œæ˜¾ç¤º"ç‚¹å‡»åŠ è½½æ›´å¤š"
                        if (comment.reply_count > comment.replies.length) {
                            html += `
                            <button class="load-more-replies" data-comment-id="${comment.cid}" data-current-page="0">
                                æ›´å¤šå›å¤ (${comment.reply_count - comment.replies.length}æ¡æœªæ˜¾ç¤º) â†˜ï¸
                            </button>
                            `;
                        }
                    } else {
                        // html += '<div class="no-replies">æš‚æ— å›å¤</div>';
                    }

                    html += `
                        </div>
                    </div>
                    `;
                });

                $('#commentsContainer').html(html);
            }

            // æ¸²æŸ“åˆ†é¡µ
            function renderPagination(total, currentPage, limit) {
                const laypage = layui.laypage;
                if (total <= limit) {
                    return;
                }
                laypage.render({
                    elem: 'paginationContainer',
                    count: total,
                    limit: limit,
                    curr: currentPage,
                    layout: ['prev', 'page', 'next', 'skip'],
                    jump: function (obj, first) {
                        if (!first) {
                            loadComments(obj.curr);
                        }
                    }
                });
            }

            // åŠ è½½æ›´å¤šå›å¤
            function loadMoreReplies(commentId, page) {
                const msgId = $('#msgId').val() || 1;
                const type = $('#type').val();
                const repliesContainer = $('#replies-' + commentId);
                const isInitialLoad = repliesContainer.data('initial-load') || false;

                $.ajax({
                    url: '/tools/comment/getReplyList',
                    method: 'GET',
                    data: {
                        comment_id: commentId,
                        msg_id: msgId,
                        type: type,
                        page: page,
                        limit: limit
                    },
                    success: function (response) {
                        if (response.code === 200) {
                            // å¦‚æœæ˜¯åˆæ¬¡åŠ è½½ï¼Œåˆ™æ›¿æ¢æ•´ä¸ªå›å¤åˆ—è¡¨
                            if (isInitialLoad) {
                                // æ¸…ç©ºç°æœ‰å†…å®¹
                                repliesContainer.empty();
                                // æ·»åŠ å›å¤å†…å®¹
                                appendRepliesList(commentId, response.data.list, response.data.userList);
                                // ç§»é™¤åˆæ¬¡åŠ è½½æ ‡è®°
                                repliesContainer.data('initial-load', false);
                            } else {
                                // æ›´æ–°å›å¤åˆ—è¡¨
                                appendRepliesList(commentId, response.data.list, response.data.userList);
                            }

                            // æ›´æ–°"åŠ è½½æ›´å¤š"æŒ‰é’®
                            const loadMoreBtn = $('.load-more-replies[data-comment-id="' + commentId + '"]');
                            const totalLoaded = $('#replies-' + commentId + ' .comment-item').length;

                            if (totalLoaded >= response.data.total) {
                                loadMoreBtn.hide();
                            } else {
                                loadMoreBtn.data('current-page', page);
                                loadMoreBtn.text(`æ›´å¤šå›å¤ (${response.data.total - totalLoaded}æ¡æœªæ˜¾ç¤º) â†˜ï¸`);
                            }
                        } else {
                            console.error('åŠ è½½å›å¤å¤±è´¥:', response.msg);
                        }
                    },
                    error: function () {
                        console.error('ç½‘ç»œé”™è¯¯ï¼ŒåŠ è½½å›å¤å¤±è´¥');
                    }
                });
            }

            // è¿½åŠ å›å¤åˆ—è¡¨
            function appendRepliesList(commentId, replies, userList) {
                const currentUid = parseInt($('#currentUid').val()) || 0;
                const repliesContainer = $('#replies-' + commentId);
                const isInitialLoad = repliesContainer.data('initial-load') || false;
                let html = '';

                replies.forEach(function (reply) {
                    const replyUser = userList[reply.fromuid] || { nickname: 'æœªçŸ¥ç”¨æˆ·', head_image: '', blog: '' };
                    const isOwnReply = reply.fromuid == currentUid;
                    const toUser = userList[reply.touid] ? userList[reply.touid].nickname : '';
                    const replyPrefix = toUser ? `@${toUser}` : '';

                    const replyAvatar = replyUser.head_image ?
                        `<a href="/${replyUser.blog}/" class="user-link"><img src="${replyUser.head_image}" class="avatar" alt="å¤´åƒ"></a>` :
                        `<a href="/${replyUser.blog}/" class="user-link"><span class="avatar">${replyUser.nickname.charAt(0).toUpperCase()}</span></a>`;

                    html += `
                    <div class="comment-item">
                        <div class="comment-header-info">
                            <div>
                                ${replyAvatar}
                                <a href="/${replyUser.blog}/" class="user-link comment-author">${replyUser.nickname}</a>
                                ${isOwnReply ? `<button class="delete-btn delete-reply" data-reply-id="${reply.cid}" data-comment-id="${commentId}">ğŸ—‘ï¸ åˆ é™¤</button>` : ''}
                            </div>
                            <div class="comment-time">${formatTime(reply.ctime)}</div>
                        </div>
                        <div class="comment-content">
                            ${replyPrefix} ${reply.msg}
                        </div>
                        <div class="action-buttons">
                            <button class="reply-btn" data-comment-id="${commentId}" data-reply-id="${reply.cid}">ğŸ’¬ å›å¤</button>
                        </div>
                    </div>
                    `;
                });

                // å¦‚æœæ˜¯åˆæ¬¡åŠ è½½ï¼Œç›´æ¥æ·»åŠ å†…å®¹
                if (isInitialLoad) {
                    repliesContainer.append(html);
                } else {
                    // å°†æ–°å›å¤æ·»åŠ åˆ°"åŠ è½½æ›´å¤š"æŒ‰é’®ä¹‹å‰
                    const loadMoreBtn = $('.load-more-replies[data-comment-id="' + commentId + '"]');
                    if (loadMoreBtn.length > 0) {
                        loadMoreBtn.before(html);
                    } else {
                        repliesContainer.append(html);
                    }
                }
            }

            // æ ¼å¼åŒ–æ—¶é—´
            function formatTime(timestamp) {
                const date = new Date(timestamp * 1000);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');

                return `${year}å¹´${month}æœˆ${day}æ—¥ ${hours}:${minutes}`;
            }

            // å‘è¡¨è¯„è®º
            function submitComment() {
                const content = $('#mainContent').val().trim();
                const msgId = $('#msgId').val() || 1; // é»˜è®¤å€¼
                const type = $('#type').val();
                const msgUid = $('#msgUid').val() || 0; // é»˜è®¤å€¼

                if (!content) {
                    layer.msg('è¯·è¾“å…¥è¯„è®ºå†…å®¹', { icon: 2 });
                    return;
                }

                $.ajax({
                    url: '/tools/comment/addComment',
                    method: 'POST',
                    data: {
                        msg_id: msgId,
                        msg_uid: msgUid,
                        type: type,
                        msg: content
                    },
                    success: function (response) {
                        if (response.code === 200) {
                            layer.msg('è¯„è®ºæˆåŠŸ', { icon: 1 });
                            $('#mainContent').val('');
                            loadComments(1); // é‡æ–°åŠ è½½ç¬¬ä¸€é¡µ
                        } else {
                            layer.msg(response.msg, { icon: 2 });
                        }
                    },
                    error: function () {
                        layer.msg('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', { icon: 2 });
                    }
                });
            }

            // å‘é€å›å¤
            function sendReply(commentId, replyContent, touid = 0) {
                const msgId = $('#msgId').val() || 1; // é»˜è®¤å€¼
                const type = $('#type').val();

                if (!replyContent) {
                    layer.msg('è¯·è¾“å…¥å›å¤å†…å®¹', { icon: 2 });
                    return;
                }

                $.ajax({
                    url: '/tools/comment/addReply',
                    method: 'POST',
                    data: {
                        msg_id: msgId,
                        type: type,
                        comment_id: commentId,
                        msg: replyContent,
                        touid: touid
                    },
                    success: function (response) {
                        if (response.code === 200) {
                            layer.msg('å›å¤æˆåŠŸ', { icon: 1 });
                            $('#replyForm-' + commentId + ' .reply-content').val('');
                            $('#replyForm-' + commentId).hide();
                            loadComments(currentPage); // é‡æ–°åŠ è½½å½“å‰é¡µ
                        } else {
                            layer.msg(response.msg, { icon: 2 });
                        }
                    },
                    error: function () {
                        layer.msg('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', { icon: 2 });
                    }
                });
            }

            // åˆ é™¤è¯„è®º
            function deleteComment(commentId) {
                layer.confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ', {
                    icon: 3,
                    title: 'åˆ é™¤ç¡®è®¤'
                }, function (index) {
                    $.ajax({
                        url: '/tools/comment/deleteComment',
                        method: 'POST',
                        data: {
                            comment_id: commentId,
                            type: $('#type').val()
                        },
                        success: function (response) {
                            if (response.code === 200) {
                                layer.msg('åˆ é™¤æˆåŠŸ', { icon: 1 });
                                loadComments(currentPage); // é‡æ–°åŠ è½½å½“å‰é¡µ
                            } else {
                                layer.msg(response.msg, { icon: 2 });
                            }
                        },
                        error: function () {
                            layer.msg('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', { icon: 2 });
                        }
                    });

                    layer.close(index);
                });
            }

            // åˆ é™¤å›å¤
            function deleteReply(replyId, commentId) {
                layer.confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å›å¤å—ï¼Ÿ', {
                    icon: 3,
                    title: 'åˆ é™¤ç¡®è®¤'
                }, function (index) {
                    $.ajax({
                        url: '/tools/comment/deleteReply',
                        method: 'POST',
                        data: {
                            reply_id: replyId,
                            type: $('#type').val()
                        },
                        success: function (response) {
                            if (response.code === 200) {
                                layer.msg('åˆ é™¤æˆåŠŸ', { icon: 1 });
                                loadComments(currentPage); // é‡æ–°åŠ è½½å½“å‰é¡µ
                            } else {
                                layer.msg(response.msg, { icon: 2 });
                            }
                        },
                        error: function () {
                            layer.msg('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', { icon: 2 });
                        }
                    });

                    layer.close(index);
                });
            }
        });
    </script>
</body>

</html>