<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>评论系统</title>
    <link rel="stylesheet" href="/static/layui/css/layui.css">
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
        }
        
        .comment-container {
            max-width: 800px;
margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .comment-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .comment-form {
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-size: 14px;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0069d9;
        }
        
        .comments-list {
            margin-top: 20px;
        }
        
        .comment-item {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
        }
        
        .comment-item:last-child {
            border-bottom: none;
        }
        
        .comment-header-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .user-link {
            text-decoration: none;
            color: #333;
            font-weight: bold;
        }
        
        .user-link:hover {
            color: #007bff;
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            vertical-align: middle;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f0f0;
            color: #666;
            font-weight: bold;
            font-size: 18px;
        }
        
        .avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .comment-author {
            margin-right: 10px;
        }
        
        .comment-time {
            color: #999;
            font-size: 12px;
        }
        
        .comment-content {
            margin: 10px 0;
            padding-left: 50px;
        }
        
        .reply-btn, .reply-toggle, .delete-btn {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            font-size: 12px;
            padding: 0;
            margin-right: 10px;
        }
        
        .reply-btn:hover, .reply-toggle:hover {
            text-decoration: underline;
        }
        
        .delete-btn {
            color: #dc3545;
        }
        
        .reply-form {
            margin: 10px 0 10px 50px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .replies {
            margin-left: 50px;
            margin-top: 10px;
        }
        
        .replies .comment-item {
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }
        
        .replies .comment-item:last-child {
            border-bottom: none;
        }
        
        .replies .comment-content {
            padding-left: 50px;
        }
        
        .replies .reply-form {
            margin-left: 0;
        }
        
        .no-comments, .no-replies {
            text-align: center;
            color: #999;
            padding: 20px 0;
        }
        
        .pagination {
            margin: 20px 0;
            text-align: center;
        }
        
        .load-more-replies {
            margin: 10px 0 10px 50px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            color: #007bff;
            cursor: pointer;
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 4px;
        }
        
        .load-more-replies:hover {
            background-color: #e9ecef;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }
        
        .error-message {
            color: #dc3545;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="comment-container">
        <h2 class="comment-title">评论列表</h2>
        
        <!-- 评论表单 -->
        <div class="comment-form">
            <div class="form-group">
                <textarea class="form-control" id="mainContent" rows="4" placeholder="写下你的评论..."></textarea>
            </div>
            <button class="btn btn-primary" id="submitComment">发表评论</button>
        </div>
        
        <!-- 评论列表容器 -->
        <div class="comments-list" id="commentsContainer">
            <div class="loading">加载中...</div>
        </div>
        
        <!-- 分页容器 -->
        <div class="pagination" id="paginationContainer"></div>
    </div>

    <!-- 隐藏字段 -->
    <input type="hidden" id="msgId" value="{$msgId|default=1}">
    <input type="hidden" id="commentId" value="{$commentId|default=0}">
    <input type="hidden" id="type" value="{$type|default='default'}">
    <input type="hidden" id="currentUid" value="{$currentUid|default=0}">

    <script src="/static/layui/layui.js"></script>
    <script>
        layui.use(['layer', 'laypage'], function() {
            const layer = layui.layer;
            const laypage = layui.laypage;
            const $ = layui.$;
            // 全局变量
            let currentPage = 1;
            const limit = 10; // 每页显示的评论数
            
            // 页面加载完成后加载评论
            $(document).ready(function() {
                loadComments(1);
                bindEvents();
            });
            
            // 绑定事件
            function bindEvents() {
                // 提交评论
                $('#submitComment').on('click', submitComment);
                
                // 回复按钮点击事件（使用事件委托）
                $(document).on('click', '.reply-btn', function() {
                    const commentId = $(this).data('comment-id');
                    const replyId = $(this).data('reply-id');
                    const replyForm = $('#replyForm-' + commentId);
                    
                    // 显示回复表单
                    replyForm.toggle();
// 如果是回复某条回复，则设置@用户
                    if (replyId) {
                        const replyContent = replyForm.find('.reply-content');
                        const replyItem = $(this).closest('.comment-item');
                        const authorName = replyItem.find('.comment-author').text();
                        replyContent.val('@' + authorName + ' ');
                        replyContent.focus();
                    }
                });
                
                // 取消回复
                $(document).on('click', '.cancel-reply', function() {
                    const commentId = $(this).data('comment-id');
                    $('#replyForm-' + commentId).hide();
                    $('#replyForm-' + commentId + ' .reply-content').val('');
                });
                
                // 发送回复
                $(document).on('click', '.send-reply', function() {
                    const commentId = $(this).data('comment-id');
                    const replyContent = $('#replyForm-' + commentId + ' .reply-content').val();
                    
                    // 提取@用户信息
                    let touid = 0;
                    if (replyContent.startsWith('@')) {
                        const match = replyContent.match(/^@([^ ]+) /);
                        if (match) {
                            // 这里需要根据用户名查找用户ID，简化处理
                            // 实际项目中应该通过AJAX请求获取用户ID
                        }
                    }
                    
                    sendReply(commentId, replyContent, touid);
                });
                
                // 展开/收起回复
                $(document).on('click', '.reply-toggle', function() {
                    const commentId = $(this).data('comment-id');
                    const repliesContainer = $('#replies-' + commentId);
                    
                    if (repliesContainer.hasClass('collapsed')) {
                        repliesContainer.removeClass('collapsed');
                        $(this).text('收起回复');
                        
                        // 如果还没有加载过回复，则加载回复
                        if (!repliesContainer.data('loaded')) {
                            // 使用loadMoreReplies函数，并添加标记表示是初次加载
                            repliesContainer.data('initial-load', true);
                            loadMoreReplies(commentId, 1);
                            repliesContainer.data('loaded', true);
                        }
                    } else {
                        repliesContainer.addClass('collapsed');
                        $(this).text('展开回复');
                    }
                });
                
                // 加载更多回复
                $(document).on('click', '.load-more-replies', function() {
                    const commentId = $(this).data('comment-id');
                    const currentPage = parseInt($(this).data('current-page')) || 0;
                    loadMoreReplies(commentId, currentPage + 1);
                });
                
                // 删除评论
                $(document).on('click', '.delete-comment', function() {
                    const commentId = $(this).data('comment-id');
                    deleteComment(commentId);
                });
                
                // 删除回复
                $(document).on('click', '.delete-reply', function() {
                    const replyId = $(this).data('reply-id');
                    const commentId = $(this).data('comment-id');
                    deleteReply(replyId, commentId);
                });
            }
            
            // 加载评论列表
            function loadComments(page) {
                currentPage = page;
                const msgId = $('#msgId').val() || 1;
                const type = $('#type').val();
                const commentId = $('#commentId').val() || 0;
                
                $('#commentsContainer').html('<div class="loading">加载中...</div>');
                
                $.ajax({
                    url: '/tools/comment/getCommentList',
                    method: 'GET',
                    data: {
                        msg_id: msgId,
                        comment_id: commentId,
                        type: type,
                        page: page,
                        limit: limit
                    },
                    success: function(response) {
                        if (response.code === 200) {
                            renderComments(response.data.list, response.data.userList);
                            renderPagination(response.data.total, page, limit);
                        } else {
                            $('#commentsContainer').html('<div class="error-message">加载失败: ' + response.msg + '</div>');
                        }
                    },
                    error: function() {
                        $('#commentsContainer').html('<div class="error-message">网络错误，请稍后重试</div>');
                    }
                });
            }
            
            // 渲染评论列表
            function renderComments(comments, userList) {
                let html = '';
                
                if(comments.length === 0) {
                    html = '<div class="no-comments">暂无评论，快来抢沙发吧！</div>';
                    $('#commentsContainer').html(html);
                    return;
                }
                
                const currentUid = parseInt($('#currentUid').val()) || 0;
                
                comments.forEach(function(comment) {
                    const user = userList[comment.fromuid] || {nickname: '未知用户', head_image: '', blog: ''};
                    const isOwnComment = comment.fromuid == currentUid;
                    
                    const avatar = user.head_image ? 
                        `<a href="/${user.blog}/" class="user-link"><img src="${user.head_image}" class="avatar" alt="头像"></a>` : 
                        `<a href="/${user.blog}/" class="user-link"><span class="avatar">${user.nickname.charAt(0).toUpperCase()}</span></a>`;
                    
                    html += `
                    <div class="comment-item" data-cid="${comment.cid}">
                        <div class="comment-header-info">
                            <div>
                                ${avatar}
                                <a href="/${user.blog}/" class="user-link comment-author">${user.nickname}</a>
                                ${isOwnComment ? `<button class="delete-btn delete-comment" data-comment-id="${comment.cid}">删除</button>` : ''}
                            </div>
                            <div class="comment-time">${formatTime(comment.ctime)}</div>
                        </div>
                        <div class="comment-content">
                            ${comment.msg}
                        </div>
                        <button class="reply-btn" data-comment-id="${comment.cid}">回复</button>

                        <!-- 回复表单 - 默认隐藏 -->
                        <div class="reply-form" id="replyForm-${comment.cid}" style="display: none;">
                            <div class="form-group">
                                <textarea class="form-control reply-content" placeholder="请输入回复内容..." data-comment-id="${comment.cid}"></textarea>
                            </div>
                            <button class="btn send-reply" data-comment-id="${comment.cid}">发送回复</button>
                            <button class="btn cancel-reply" style="background-color: #999; margin-left: 10px;" data-comment-id="${comment.cid}">取消</button>
                        </div>

                        <!-- 回复数量按钮 -->
                        <button class="reply-toggle" data-comment-id="${comment.cid}" data-total-replies="${comment.reply_count}">
                            共${comment.reply_count}条回复
                        </button>

                        <!-- 回复列表 -->
                        <div class="replies collapsed" id="replies-${comment.cid}">
                    `;
                    
                    // 渲染relation_reply_id对应的回复
                    if(comment.replies && comment.replies.length > 0) {
                        comment.replies.forEach(function(reply, index) {
                            const replyUser = userList[reply.fromuid] || {nickname: '未知用户', head_image: '', blog: ''};
                            const isOwnReply = reply.fromuid == currentUid;
                            const toUser = userList[reply.touid] ? userList[reply.touid].nickname : '';
                            const replyPrefix = toUser ? `@${toUser}` : '';
                            
                            const replyAvatar = replyUser.head_image ? 
                                `<a href="/${replyUser.blog}/" class="user-link"><img src="${replyUser.head_image}" class="avatar" alt="头像"></a>` : 
                                `<a href="/${replyUser.blog}/" class="user-link"><span class="avatar">${replyUser.nickname.charAt(0).toUpperCase()}</span></a>`;
                            
                            html += `
                            <div class="comment-item">
                                <div class="comment-header-info">
                                    <div>
                                        ${replyAvatar}
                                        <a href="/${replyUser.blog}/" class="user-link comment-author">${replyUser.nickname}</a>
                                        ${isOwnReply ? `<button class="delete-btn delete-reply" data-reply-id="${reply.cid}" data-comment-id="${comment.cid}">删除</button>` : ''}
                                    </div>
                                    <div class="comment-time">${formatTime(reply.ctime)}</div>
                                </div>
                                <div class="comment-content">
                                    ${replyPrefix} ${reply.msg}
                                </div>
                                <button class="reply-btn" data-comment-id="${comment.cid}" data-reply-id="${reply.cid}">回复</button>
                            </div>
                            `;
                        });
                        
                        // 如果回复数大于relation_reply_id数量，显示"点击加载更多"
                        if(comment.reply_count > comment.replies.length) {
                            html += `
                            <button class="load-more-replies" data-comment-id="${comment.cid}" data-current-page="0">
                                点击加载更多回复 (${comment.reply_count - comment.replies.length} 条未显示)
                            </button>
                            `;
                        }
                    } else {
                        // html += '<div class="no-replies">暂无回复</div>';
                    }
                    
                    html += `
                        </div>
                    </div>
                    `;
                });
                
                $('#commentsContainer').html(html);
            }
            
            // 渲染分页
            function renderPagination(total, currentPage, limit) {
                const laypage = layui.laypage;
                if (total <= limit) {
                    return;
                }
                laypage.render({
                    elem: 'paginationContainer',
                    count: total,
                    limit: limit,
                    curr: currentPage,
                    layout: ['prev', 'page', 'next', 'skip'],
                    jump: function(obj, first) {
                        if(!first) {
                            loadComments(obj.curr);
                        }
                    }
                });
            }
            
            // 加载更多回复
            function loadMoreReplies(commentId, page) {
                const msgId = $('#msgId').val() || 1;
                const type = $('#type').val();
                const repliesContainer = $('#replies-' + commentId);
                const isInitialLoad = repliesContainer.data('initial-load') || false;
                
                $.ajax({
                    url: '/tools/comment/getReplyList',
                    method: 'GET',
                    data: {
                        comment_id: commentId,
                        msg_id: msgId,
                        type: type,
                        page: page,
                        limit: limit
                    },
                    success: function(response) {
                        if (response.code === 200) {
                            // 如果是初次加载，则替换整个回复列表
                            if (isInitialLoad) {
                                // 清空现有内容
                                repliesContainer.empty();
                                // 添加回复内容
                                appendRepliesList(commentId, response.data.list, response.data.userList);
                                // 移除初次加载标记
                                repliesContainer.data('initial-load', false);
                            } else {
                                // 更新回复列表
                                appendRepliesList(commentId, response.data.list, response.data.userList);
                            }
                            
                            // 更新"加载更多"按钮
                            const loadMoreBtn = $('.load-more-replies[data-comment-id="' + commentId + '"]');
                            const totalLoaded = $('#replies-' + commentId + ' .comment-item').length;
                            
                            if (totalLoaded >= response.data.total) {
                                loadMoreBtn.hide();
                            } else {
                                loadMoreBtn.data('current-page', page);
                                loadMoreBtn.text(`点击加载更多回复 (${response.data.total - totalLoaded} 条未显示)`);
                            }
                        } else {
                            console.error('加载回复失败:', response.msg);
                        }
                    },
                    error: function() {
                        console.error('网络错误，加载回复失败');
                    }
                });
            }
            
            // 追加回复列表
            function appendRepliesList(commentId, replies, userList) {
                const currentUid = parseInt($('#currentUid').val()) || 0;
                const repliesContainer = $('#replies-' + commentId);
                const isInitialLoad = repliesContainer.data('initial-load') || false;
                let html = '';
                
                replies.forEach(function(reply) {
                    const replyUser = userList[reply.fromuid] || {nickname: '未知用户', head_image: '', blog: ''};
                    const isOwnReply = reply.fromuid == currentUid;
                    const toUser = userList[reply.touid] ? userList[reply.touid].nickname : '';
                    const replyPrefix = toUser ? `@${toUser}` : '';
                    
                    const replyAvatar = replyUser.head_image ? 
                        `<a href="/${replyUser.blog}/" class="user-link"><img src="${replyUser.head_image}" class="avatar" alt="头像"></a>` : 
                        `<a href="/${replyUser.blog}/" class="user-link"><span class="avatar">${replyUser.nickname.charAt(0).toUpperCase()}</span></a>`;
                    
                    html += `
                    <div class="comment-item">
                        <div class="comment-header-info">
                            <div>
                                ${replyAvatar}
                                <a href="/${replyUser.blog}/" class="user-link comment-author">${replyUser.nickname}</a>
                                ${isOwnReply ? `<button class="delete-btn delete-reply" data-reply-id="${reply.cid}" data-comment-id="${commentId}">删除</button>` : ''}
                            </div>
                            <div class="comment-time">${formatTime(reply.ctime)}</div>
                        </div>
                        <div class="comment-content">
                            ${replyPrefix} ${reply.msg}
                        </div>
                        <button class="reply-btn" data-comment-id="${commentId}" data-reply-id="${reply.cid}">回复</button>
                    </div>
                    `;
                });
                
                // 如果是初次加载，直接添加内容
                if (isInitialLoad) {
                    repliesContainer.append(html);
                } else {
                    // 将新回复添加到"加载更多"按钮之前
                    const loadMoreBtn = $('.load-more-replies[data-comment-id="' + commentId + '"]');
                    if (loadMoreBtn.length > 0) {
                        loadMoreBtn.before(html);
                    } else {
                        repliesContainer.append(html);
                    }
                }
            }
            
            // 格式化时间
            function formatTime(timestamp) {
                const date = new Date(timestamp * 1000);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                return `${year}年${month}月${day}日 ${hours}:${minutes}`;
            }
            
            // 发表评论
            function submitComment() {
                const content = $('#mainContent').val().trim();
                const msgId = $('#msgId').val() || 1; // 默认值
                const type = $('#type').val();
                
                if(!content) {
                    layer.msg('请输入评论内容', {icon: 2});
                    return;
                }
                
                $.ajax({
                    url: '/tools/comment/addComment',
                    method: 'POST',
                    data: {
                        msg_id: msgId,
                        type: type,
                        msg: content
                    },
                    success: function(response) {
                        if(response.code === 200) {
                            layer.msg('评论成功', {icon: 1});
                            $('#mainContent').val('');
                            loadComments(1); // 重新加载第一页
                        } else {
                            layer.msg(response.msg, {icon: 2});
                        }
                    },
                    error: function() {
                        layer.msg('网络错误，请稍后重试', {icon: 2});
                    }
                });
            }
            
            // 发送回复
            function sendReply(commentId, replyContent, touid = 0) {
                const msgId = $('#msgId').val() || 1; // 默认值
                const type = $('#type').val();
                
                if(!replyContent) {
                    layer.msg('请输入回复内容', {icon: 2});
                    return;
                }
                
                $.ajax({
                    url: '/tools/comment/addReply',
                    method: 'POST',
                    data: {
                        msg_id: msgId,
                        type: type,
                        comment_id: commentId,
                        msg: replyContent,
                        touid: touid
                    },
                    success: function(response) {
                        if(response.code === 200) {
                            layer.msg('回复成功', {icon: 1});
                            $('#replyForm-' + commentId + ' .reply-content').val('');
                            $('#replyForm-' + commentId).hide();
                            loadComments(currentPage); // 重新加载当前页
                        } else {
                            layer.msg(response.msg, {icon: 2});
                        }
                    },
                    error: function() {
                        layer.msg('网络错误，请稍后重试', {icon: 2});
                    }
                });
            }
            
            // 删除评论
            function deleteComment(commentId) {
                layer.confirm('确定要删除这条评论吗？', {
                    icon: 3,
                    title: '删除确认'
                }, function(index) {
                    $.ajax({
                        url: '/tools/comment/deleteComment',
                        method: 'POST',
                        data: {
                            comment_id: commentId
                        },
                        success: function(response) {
                            if(response.code === 200) {
                                layer.msg('删除成功', {icon: 1});
                                loadComments(currentPage); // 重新加载当前页
                            } else {
                                layer.msg(response.msg, {icon: 2});
                            }
                        },
                        error: function() {
                            layer.msg('网络错误，请稍后重试', {icon: 2});
                        }
                    });
                    
                    layer.close(index);
                });
            }
            
            // 删除回复
            function deleteReply(replyId, commentId) {
                layer.confirm('确定要删除这条回复吗？', {
                    icon: 3,
                    title: '删除确认'
                }, function(index) {
                    $.ajax({
                        url: '/tools/comment/deleteReply',
                        method: 'POST',
                        data: {
                            reply_id: replyId
                        },
                        success: function(response) {
                            if(response.code === 200) {
                                layer.msg('删除成功', {icon: 1});
                                loadComments(currentPage); // 重新加载当前页
                            } else {
                                layer.msg(response.msg, {icon: 2});
                            }
                        },
                        error: function() {
                            layer.msg('网络错误，请稍后重试', {icon: 2});
                        }
                    });
                    
                    layer.close(index);
                });
            }
        });
    </script>
</body>
</html>