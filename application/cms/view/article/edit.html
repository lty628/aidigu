   
   {{include file='article/header' /}}

    <!-- 主内容 -->
    <main class="main-content">
        <div class="container">
            <div class="article-edit-card">
                <div class="card-header">
                    <h2 class="card-title">{{$article ? '编辑文章' : '发表文章'}}</h2>
                </div>
                <div class="card-body">
                    <div class="form-row type-row">
                        <div class="form-col">
                            <label class="form-label">分类</label>
                            <select name="category-id" class="form-select">
                                {{volist name="categoryList" id="vo"}}
                                <option value="{{$vo.category_id}}" {{$article && $vo.category_id == $article.category.category_id ? 'selected' : ''}}>{{$vo.category_name}}</option>
                                {{/volist}}
                            </select>
                        </div>
                    </div>
                    <div class="form-row title-row">
                        <div class="form-col">
                            <label class="form-label">标题</label>
                            <input type="text" name="title" class="form-input" 
                                value="{{$article ? $article.title : ''}}" 
                                placeholder="请输入标题" autocomplete="off" />
                        </div>
                    </div>
                    <div class="form-row title-row">
                        <div class="form-col">
                            <label class="form-label">摘要</label>
                            <input type="text" name="content_filtered" class="form-input"
                                value="{{$article ? $article.content_filtered : ''}}" 
                                placeholder="请输入摘要" autocomplete="off" />
                        </div>
                    </div>
                    <div class="form-row content-row">
                        <div class="form-col">
                            <label class="form-label">内容</label>
                            <div id="msgToolBar" class="editor-toolbar"></div>
                            <div id="msgInput" class="editor-container">
                                <textarea style="display:none;" class="editor-textarea"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="mediaVal" value="{{$article ? $article.content_extra.article_media : ''}}">
                {{if $article}}
                <input type="hidden" value="{{$article.content_id}}" name="content_id" id="content_id">
                {{/if}}
                <div class="card-footer">
                    <button type="submit" id="kt_commit_submit" class="submit-btn">{{$article ? '保存修改' : '发表文章'}}</button>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    {{include file='article/footer' /}}

    <script type="text/javascript" src="{{$Think.STATIC_URL}}static/common/js/wangEditor.min.js"></script>
    <script src="{{$Think.STATIC_URL}}static/cms/js/edit.js"></script>
    <script src="{{$Think.STATIC_URL}}static/layui/layui.js"></script>
    <script>var $ = layui.jquery;</script>
    <script>
        $(function () {
            // 初始化编辑器内容
            {{if $article}}

                editor.txt.html({{$article.content | raw}} );

            {{/if}}
            

            // 提交表单
            $("#kt_commit_submit").click(function () {
                var info = {};
                info.content_filtered = $("input[name='content_filtered']").val();
                info.content = editor.txt.html();
                info.title = $("input[name='title']").val();
                info.category_id = $("select[name='category-id']").val();
                var article_media = $("#mediaVal").val();
                var content_id = $("#content_id").val();

                // 验证
                if (!info.title) {
                    layer.msg("请填写标题");
                    return;
                }

                if (!info.content) {
                    layer.msg("请填写内容");
                    return;
                }

                // 确定提交URL
                var url = content_id ? "/cms/api/articleEdit" : "/cms/api/articleAdd";
                var data = { info: info, article_media: article_media };
                
                // 如果是编辑，添加content_id
                if (content_id) {
                    data.content_id = content_id;
                }

                $.ajax({
                    type: "POST",
                    url: url,
                    data: data,
                    dataType: "json",
                    success: function (json) {
                        if (!json.code) {
                            layer.msg(json.msg);
                        } else {
                            layer.msg(json.msg);
                            window.location.reload()
                            // 发表成功后可以跳转到文章列表或详情页
                            // setTimeout(function() {
                            //     window.location.href = "/news";
                            // }, 1500);
                        }
                    }
                })
                .always(function () {
                    // 加载完成后的处理
                })
                .complete(function () {
                    layer.closeAll('loading', function () {});
                });
            });
        });
    </script>
</body>
</html>