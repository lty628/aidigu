{include file='index/header' /}

<!-- 下拉刷新提示 -->
<div id="pullRefreshIndicator" style="position: fixed; top: 0; left: 0; width: 100%; height: 60px; background: #f8f8f8; text-align: center; line-height: 60px; z-index: 9999; display: none; border-bottom: 1px solid #ddd;">
    <span id="pullRefreshText">下拉刷新</span>
</div>

{if $userInfo.isSiteUser}
    <!-- 新增悬浮固定发布按钮 -->
    <!-- <div id="floating_publish_button" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 999;">
        <button class="button layui-btn layui-btn-danger" style="background-color: orange; color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 14px; display: flex; align-items: center; justify-content: center;" onclick="openCommentFormModal()">+</button>
    </div> -->
    <!-- 新增一个容器用于包裹评论表单，并默认隐藏 -->
    <div id="comment_form_container" >
        <div method="post" class="comment_form" action="" id="comment_form">
            <!-- <small></small> -->
            <div id="msgInput" class="text" maxlength="2800" onkeyup="check_len1()">
                <!-- <p>你在做什么呢</p> -->
            </div>
            <input type="hidden" id="topicTitle" value="{$topicTitle | default=''}">
            <div class="postnow" >
                <!-- <span>
                    <input type="button" value="发布" class="button layui-btn layui-btn" id="sendButton" />
                </span> -->
                <span style="margin-left: 3%;">你还可以发布<em id="leftlen1">2800</em>字</span>
            </div>

            <!-- 表情等 -->
            <div id="msgToolBar" class="toolbar"></div>
            <div class="tool-up-class" style="display: none;">
                <div class="imgHtml" style="display: block;border-radius: 3px;">
                    <!-- <img src="" width="70px" alt=""> -->
                    上传成功！
                    <i class="layui-icon layui-icon-close-fill" onclick="removeImg(this)"
                        style="color: red;cursor:pointer;font-size:20px!important"></i>
                </div>
                <input type="hidden" id="mediaVal">
            </div>
            <br />

            <p><input type="submit" id="sendButton" value="嘀咕~" class="form_submit" /></p>
        </div>
    </div>
    <script>
        // 引入 layer 插件（如果未引入，需要先引入）
        // layui.use('layer', function(){
        //     var layer = layui.layer;
        // });

        // 打开评论表单弹框的函数
        function openCommentFormModal() {
            layer.open({
                type: 1,
                title: '评论表单',
                content: $('#comment_form_container'),
                area: ['100%','400px'],
                shadeClose: true
            });
        }
    </script>
{/if}
<input type="hidden" id="userInfo" value="{$userInfo|json_encode}" />
<div id="msgContent">
	<!-- <div class="post">
		<img class="post-head" src="" />
		<div class="post-article">
			<div class="post-info-i">
				<h2><a title="张三" href="">张三</a></h2>
				<small><i class="fa fa-clock-o"></i>2023-11-11
				<i class="fa fa-eye"></i>
				<a href=""><i class="fa fa-pencil-square-o"></i>编辑</a></small>
			</div>
			<div class="post-content">
			<p class="more"><a href="" title="asdfasfasf">继续阅读</a></p>
			</div>
		</div>
		<div class="clear"></div>
		<div class="post-meta">
				<span><i class="fa fa-user"></i><a href="asdfasfdasd">张三</a></span>
				<span><i class="fa fa-inbox"></i>safasdfas</span>
				<span><i class="fa fa-comment"></i>('1111 条')</span>
				<div class="clear"></div>
		</div>
	</div>	 -->
</div>


<div  id="showMore" class="sidebar-mb-show">
	<div class="box sidebar-readmore">
		<div class="box-body"><stonrg>加载中...</stonrg></div>
	</div>
</div>
<!-- 回到顶部 -->
<!-- <section class="back-to-top">
	回到顶部
</section> -->
<script>
	/**
	* 缓冲函数
	* @param {Number} position 当前滚动位置
	* @param {Number} destination 目标位置
	* @param {Number} rate 缓动率
	* @param {Function} callback 缓动结束回调函数 两个参数分别是当前位置和是否结束
	*/
	var easeout = function (position, destination, rate, callback) {
		if (position === destination || typeof destination !== 'number') {
			return false;
		}
		destination = destination || 0;
		rate = rate || 2;

		// 不存在原生`requestAnimationFrame`，用`setTimeout`模拟替代
		if (!window.requestAnimationFrame) {
			window.requestAnimationFrame = function (fn) {
				return setTimeout(fn, 17);
			}
		}

		var step = function () {
			position = position + (destination - position) / rate;
			if (Math.abs(destination - position) < 1) {
				callback(destination, true);
				return;
			}
			callback(position, false);
			requestAnimationFrame(step);
		};
		step();
	}

	var scrollTopSmooth = function (position) {
		// 当前滚动高度
		var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
		easeout(scrollTop, position, 5, function (val) {
			window.scrollTo(0, val);
		});
	}

</script>
<script>
	// 缓存管理功能
	var CacheManager = {
		// 缓存前缀
		cachePrefix: 'msg_cache_',
		// 滚动位置缓存键
		scrollPosKey: 'scroll_position_',
		// 缓存过期时间（30分钟）
		cacheExpireTime: 30 * 60 * 1000,
		
		// 生成缓存键
		getCacheKey: function(page, url) {
			return this.cachePrefix + btoa(url || window.location.pathname) + '_' + page;
		},
		
		// 生成滚动位置缓存键
		getScrollPosKey: function(url) {
			return this.scrollPosKey + btoa(url || window.location.pathname);
		},
		
		// 设置缓存
		setCache: function(page, data, url) {
			try {
				var cacheKey = this.getCacheKey(page, url);
				var cacheData = {
					data: data,
					timestamp: new Date().getTime(),
					expireTime: this.cacheExpireTime
				};
				localStorage.setItem(cacheKey, JSON.stringify(cacheData));
				return true;
			} catch (e) {
				console.warn('缓存设置失败:', e);
				return false;
			}
		},
		
		// 获取缓存
		getCache: function(page, url) {
			try {
				var cacheKey = this.getCacheKey(page, url);
				var cacheStr = localStorage.getItem(cacheKey);
				if (!cacheStr) return null;
				
				var cacheData = JSON.parse(cacheStr);
				var currentTime = new Date().getTime();
				
				// 检查缓存是否过期
				if (currentTime - cacheData.timestamp > cacheData.expireTime) {
					this.removeCache(page, url);
					return null;
				}
				
				return cacheData.data;
			} catch (e) {
				console.warn('缓存获取失败:', e);
				return null;
			}
		},
		
		// 删除缓存
		removeCache: function(page, url) {
			try {
				var cacheKey = this.getCacheKey(page, url);
				localStorage.removeItem(cacheKey);
				return true;
			} catch (e) {
				console.warn('缓存删除失败:', e);
				return false;
			}
		},
		
		// 保存滚动位置
		saveScrollPosition: function(url) {
			try {
				var scrollPos = window.pageYOffset || document.documentElement.scrollTop;
				var scrollKey = this.getScrollPosKey(url);
				var scrollData = {
					position: scrollPos,
					timestamp: new Date().getTime()
				};
				localStorage.setItem(scrollKey, JSON.stringify(scrollData));
				return true;
			} catch (e) {
				console.warn('滚动位置保存失败:', e);
				return false;
			}
		},
		
		// 恢复滚动位置
		restoreScrollPosition: function(url) {
			try {
				var scrollKey = this.getScrollPosKey(url);
				var scrollStr = localStorage.getItem(scrollKey);
				if (!scrollStr) return false;
				
				var scrollData = JSON.parse(scrollStr);
				window.scrollTo(0, scrollData.position);
				return true;
			} catch (e) {
				console.warn('滚动位置恢复失败:', e);
				return false;
			}
		},
		
		// 清理所有过期缓存
		cleanExpiredCache: function() {
			try {
				var keysToRemove = [];
				for (var i = 0; i < localStorage.length; i++) {
					var key = localStorage.key(i);
					if (key && key.startsWith(this.cachePrefix)) {
						try {
							var cacheStr = localStorage.getItem(key);
							var cacheData = JSON.parse(cacheStr);
							var currentTime = new Date().getTime();
							
							if (currentTime - cacheData.timestamp > cacheData.expireTime) {
								keysToRemove.push(key);
							}
						} catch (e) {
							// 如果解析失败，也删除该缓存
							keysToRemove.push(key);
						}
					}
				}
				
				keysToRemove.forEach(function(key) {
					localStorage.removeItem(key);
				});
				
				return keysToRemove.length;
			} catch (e) {
				console.warn('缓存清理失败:', e);
				return 0;
			}
		},
		
		// 清理所有缓存
		clearAllCache: function() {
			try {
				var keysToRemove = [];
				for (var i = 0; i < localStorage.length; i++) {
					var key = localStorage.key(i);
					if (key && key.startsWith(this.cachePrefix)) {
						keysToRemove.push(key);
					}
				}
				
				keysToRemove.forEach(function(key) {
					localStorage.removeItem(key);
				});
				
				return keysToRemove.length;
			} catch (e) {
				console.warn('缓存清理失败:', e);
				return 0;
			}
		}
	};

	// 下拉刷新功能
	var PullRefresh = {
		startY: 0,
		currentY: 0,
		isRefreshing: false,
		threshold: 80, // 下拉阈值
		isEnabled: false, // 是否启用下拉刷新
		
		init: function() {
			// 检查是否在移动设备上
			if ('ontouchstart' in window) {
				document.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: false });
				document.addEventListener('touchmove', this.handleTouchMove.bind(this), { passive: false });
				document.addEventListener('touchend', this.handleTouchEnd.bind(this));
				console.log('下拉刷新功能已启用');
			} else {
				console.log('非移动设备，下拉刷新功能未启用');
			}
		},
		
		handleTouchStart: function(e) {
			// 只有在页面顶部且没有在刷新时才启用下拉刷新
			var scrollTop = window.pageYOffset || document.documentElement.scrollTop;
			if (scrollTop <= 10 && !this.isRefreshing) {
				this.startY = e.touches[0].pageY;
				this.currentY = this.startY;
				this.isEnabled = true;
			} else {
				this.isEnabled = false;
			}
		},
		
		handleTouchMove: function(e) {
			if (!this.isEnabled || this.isRefreshing) return;
			
			this.currentY = e.touches[0].pageY;
			var deltaY = this.currentY - this.startY;
			
			// 只有向下拉动才显示刷新指示器
			if (deltaY > 0) {
				e.preventDefault();
				this.updateIndicator(deltaY);
			}
		},
		
		handleTouchEnd: function(e) {
			if (!this.isEnabled || this.isRefreshing) return;
			
			var deltaY = this.currentY - this.startY;
			
			if (deltaY > this.threshold) {
				this.startRefresh();
			} else {
				this.hideIndicator();
			}
			
			this.startY = 0;
			this.currentY = 0;
			this.isEnabled = false;
		},
		
		updateIndicator: function(deltaY) {
			var indicator = document.getElementById('pullRefreshIndicator');
			var text = document.getElementById('pullRefreshText');
			
			if (!indicator || !text) {
				console.error('下拉刷新指示器元素未找到');
				return;
			}
			
			if (deltaY > this.threshold) {
				text.textContent = '释放刷新';
				indicator.style.background = '#e8f4fd';
			} else {
				text.textContent = '下拉刷新';
				indicator.style.background = '#f8f8f8';
			}
			
			indicator.style.display = 'block';
			indicator.style.transform = 'translateY(' + Math.min(deltaY, this.threshold * 2) + 'px)';
		},
		
		hideIndicator: function() {
			var indicator = document.getElementById('pullRefreshIndicator');
			if (indicator) {
				indicator.style.display = 'none';
				indicator.style.transform = 'translateY(0)';
			}
		},
		
		startRefresh: function() {
			this.isRefreshing = true;
			var indicator = document.getElementById('pullRefreshIndicator');
			var text = document.getElementById('pullRefreshText');
			
			if (indicator && text) {
				text.textContent = '刷新中...';
				indicator.style.background = '#d4edda';
			}
			
			// 显示刷新动画
			this.showRefreshAnimation();
			
			// 清空所有缓存
			CacheManager.clearAllCache();
			
			// 延迟刷新页面，让用户看到刷新效果
			setTimeout(function() {
				location.reload();
			}, 1000);
		},
		
		showRefreshAnimation: function() {
			// 添加简单的刷新动画
			var indicator = document.getElementById('pullRefreshIndicator');
			if (indicator) {
				indicator.style.transition = 'all 0.3s ease';
				indicator.style.height = '80px';
			}
		},
		
		// 手动触发下拉刷新（用于测试）
		manualRefresh: function() {
			if (!this.isRefreshing) {
				this.startRefresh();
			}
		}
	};

	// 添加测试函数到全局作用域
	window.testPullRefresh = function() {
		PullRefresh.manualRefresh();
	};

	// 页面加载时初始化
	$(document).ready(function() {
		var cleanedCount = CacheManager.cleanExpiredCache();
		if (cleanedCount > 0) {
			console.log('清理了 ' + cleanedCount + ' 个过期缓存');
		}
		
		// 初始化下拉刷新
		PullRefresh.init();
		
		// 页面加载完成后恢复滚动位置
		setTimeout(function() {
			CacheManager.restoreScrollPosition();
		}, 100);
		
		// 添加调试信息
		console.log('页面加载完成，下拉刷新功能已初始化');
		console.log('测试方法: 在控制台输入 testPullRefresh() 或 PullRefresh.manualRefresh()');
	});

	// 页面卸载前保存滚动位置
	window.addEventListener('beforeunload', function() {
		CacheManager.saveScrollPosition();
	});

	// 添加键盘快捷键支持（用于测试）
	document.addEventListener('keydown', function(e) {
		// Ctrl+R 或 Cmd+R 触发下拉刷新
		if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
			e.preventDefault();
			PullRefresh.manualRefresh();
		}
	});

	var page = 0;
	$(function () {
		var canLoad = true
		
		// 修改后的初始化下一页函数，支持缓存
		function initNextPage(url) {
			if (!canLoad) return
			page++
			canLoad = false
			var url = window.location.pathname
			
			// 先尝试从缓存获取数据
			var cachedData = CacheManager.getCache(page, url);
			if (cachedData) {
				console.log('使用缓存数据，页码:', page);
				processData(cachedData, true);
				return;
			}
			
			// 缓存中没有数据，发起AJAX请求
			$.ajax({
				type: "get",
				url: url,
				data: { page: page },
				dataType: "json",
			})
				.done(function (json) {
					var data = json.data.data
					
					if (json?.code === 0) {
					    // 显示提示信息
					    alertMsg(json?.msg || '加载数据失败');
					    // 2 秒后将 canLoad 设置为 true
					    setTimeout(() => {
					        canLoad = true;
					    }, 2000);
					    return;
					}
					
					// 缓存获取到的数据
					CacheManager.setCache(page, json, url);
					
					processData(json, false);
				})
				.always(function () {
				})
				.fail(function () {
					canLoad = true;
				});
		}
		
		// 处理数据的通用函数
		function processData(json, fromCache) {
			var data = json.data.data;
			
			if (fromCache) {
				// 如果是缓存数据，直接处理
				renderData(data, json);
				canLoad = true;
			} else {
				// 如果是新数据，正常处理流程
				renderData(data, json);
				
				if (data.length < 8) {
					$("#showMore").hide()
					return
				}
				
				canLoad = true;
			}
		}
		
		// 渲染数据的函数
		function renderData(data, json) {
			for (var i = 0; i < data.length; i++) {
				var mediaStr = '';
				var str = '';
				var delStr = '';
				var c1 = '';
				var c2 = '';
				if (data[i].media) {
					data[i].media_info = $.parseJSON(data[i].media_info)
					if (data[i].media_info.media_type == 'mp4' || data[i].media_info.media_type == 'm3u8') {
						mediaStr = '<p class="massageImg clear showVideo' + data[i].msg_id + '" vid="' + data[i].media + '"><video width="400px"  controls=""  name="media"><source src="" type="video/mp4"></video></p>';
					} else if (data[i].media_info.media_type == 'mp3') {
							mediaStr = '<p class="massageImg clear"><audio id="music_'+data[i].msg_id+'" class="music" controls="controls" loop="loop" onplay="stopOther(this); event.stopPropagation();" preload="none" controlsList="nodownload" οncοntextmenu="return false" name="media"><source src="'+data[i].media+'" type="audio/mpeg"></audio></p>';
						}  else {
						mediaStr = '<p  class="massageImg clear"><img class="massageImgCommon massageImg_'+data[i].media_info.media_type+'"  onclick="showMessageImg(this)" src="' + data[i].media + '"></p>';
					}
				}
				if (0 != data[i].commentsum) {
					c2 = '(' + data[i].commentsum + ')'
				}
				// 添加样式类以实现右侧对齐和样式美化
				delStr += '<div class="post-meta-icons" style="text-align: right;">'; 
				delStr += '<span><a href="/' + data[i].blog + '/message/' + data[i].msg_id + '"><i class="layui-icon layui-icon-eye"></i> 查看</a></span>';
				delStr += '<span><a href="javascript:;" data-title="评论" data-url="/chat/messageChatId/' + data[i].msg_id + '" onclick="showFrameHtml(this, \'100%\', \'100%\')"><i class="layui-icon layui-icon-reply-fill"></i> 评论' + c2 + '</a></span>';
				if (json.data.allow_delete) {
					delStr += '<span><a href="/' + data[i].blog + '/del/message/' + data[i].msg_id + '"><i class="layui-icon layui-icon-delete"></i> 删除</a></span>';
				} else if(json.data.is_collect) {
					delStr += '<span><a href="javascript:void(0);" onclick="collectMsg(' + data[i].msg_id + ',1);"><i class="layui-icon layui-icon-star-fill"></i> 取消收藏</a></span>';
				} else {
					delStr += '<span><a href="javascript:void(0);" onclick="collectMsg(' + data[i].msg_id + ',0);"><i class="layui-icon layui-icon-star"></i> 收藏</a></span>';
				}
				delStr += '</div>'; // 关闭样式类
				str = '<div class="post"><img class="post-head" src="' + data[i].head_image + '" />'
					+ '<div class="post-article">'
					+ '<div class="post-info-i">'
					+ '<h2><a href="/' + data[i].blog + '/own/">' + data[i].nickname + '</a></h2><small><i class="fa fa-clock-o"></i>'+getDateDiff(data[i].ctime)+'<i class="fa fa-eye"></i>'+' 来自' + data[i].refrom+'</small>'
					+ '</div>'
					+ '<div class="post-content"><div class="post-text">' + data[i].contents + data[i].repost + '</div>'  + mediaStr + '</div>'
					+ '</div>'
					+ '<div class="clear"></div>'
					+ '<div class="post-meta">'+delStr+'</div>'
					+ '<div class="clear"></div>'
					+ '</div>'
					+ '</div>';

				$("#msgContent").append(str);
				iniVideo(data[i].msg_id)
			}
		}
		
		// 添加手动刷新缓存的功能（可用于调试）
		window.refreshCache = function() {
			CacheManager.clearAllCache();
			alertMsg('缓存已清空，页面将重新加载数据');
			location.reload();
		};
		
		// 添加查看缓存状态的功能
		window.showCacheStatus = function() {
			var cacheCount = 0;
			for (var i = 0; i < localStorage.length; i++) {
				var key = localStorage.key(i);
				if (key && key.startsWith(CacheManager.cachePrefix)) {
					cacheCount++;
				}
			}
			alertMsg('当前缓存数量: ' + cacheCount + ' 条');
		};

		$(window).scroll(function () {
			var top = $(window).scrollTop();
			var winH = $(window).height();
			var docH = $(document).height();
			if (docH <= (top + winH + 200)) {
				initNextPage(page)
			}
		});
		initNextPage(page)
	})

</script>
<script>
	
</script>
{include file='index/foot' /}